# Тест цепочки: конфигурация → корзина → заказ → экспорт

## Автоматический тест (без браузера)

Скрипт проверяет, что заказ с полным `cart_data` (включая `breakdown`) после экспорта в Excel содержит ожидаемые ячейки (опции двери и колонки «X, цена»).

**Требования:** PostgreSQL, в `.env` задан `DATABASE_URL=postgresql://...`. В БД должен быть хотя бы один клиент (например, после seed).

```bash
npx tsx scripts/verify-order-export-cycle.ts
```

Скрипт:
1. Берёт первого активного клиента из БД.
2. Создаёт заказ с одной позицией двери (кромка, порог, наличники) и полным `breakdown`.
3. Вызывает экспорт в Excel через `exportService.exportDocument`.
4. Сохраняет файл в `scripts/output/verify-order-export.xlsx`.
5. Проверяет в Excel наличие: Кромка, Цвет кромки, Порог, Наличники, колонки «Кромка, цена», «Порог, цена», «Наличники, цена», «Название модели».

При успехе в консоли: «Цикл проверен: заказ с полными данными → экспорт → в Excel заполнены опции и колонки «X, цена».»

---

## Ручной тест (конфигуратор → корзина → заказ → экспорт)

Управлять браузером из этой сессии нельзя (нужно подключить Browser MCP). Ниже — пошаговый чеклист для ручной проверки.

### 1. Конфигуратор (/doors)

- [ ] Открыть http://localhost:3000/doors (запущен `npm run dev`).
- [ ] Выбрать модель, покрытие, цвет, размер (например 800×2000).
- [ ] Включить опции: кромка (цвет), порог, наличники, ручка (при необходимости).
- [ ] Дождаться расчёта цены (в интерфейсе отображается сумма).
- [ ] Нажать «В корзину».

### 2. Корзина

- [ ] Открыть корзину (иконка/кнопка корзины).
- [ ] В корзине одна позиция двери с названием и ценой.
- [ ] (Опционально) В devtools → Application → Local Storage или состояние приложения проверить, что у позиции есть поле `breakdown` (массив с метками и суммами).

### 3. Создание заказа

- [ ] Выбрать клиента (если требуется).
- [ ] Создать заказ из корзины (кнопка «Создать заказ» / аналог).
- [ ] Убедиться, что заказ создан (сообщение или переход к списку заказов).

### 4. Экспорт Excel (ЛК исполнителя или модалка заказа)

- [ ] Войти в ЛК исполнителя (или открыть заказ в модалке, где есть экспорт).
- [ ] Открыть только что созданный заказ.
- [ ] Нажать «Заказ из БД» / «Экспорт заказа у поставщика» (Excel).
- [ ] Скачался файл .xlsx.

### 5. Проверка Excel

- [ ] Открыть скачанный файл.
- [ ] Лист «Заказ»: есть строка заголовков (№, Наименование, Количество, Цена, Сумма, Название модели, … Кромка, Порог, Наличники, Кромка, цена, Порог, цена, Наличники, цена и т.д.).
- [ ] В строке данных: заполнены №, Наименование, Количество, Цена, Сумма.
- [ ] В колонках опций: для выбранных опций стоят ожидаемые значения (например «да» для Порога, Кромки; для наличников — название или «да»).
- [ ] В колонках «X, цена» (Кромка, цена; Порог, цена; Наличники, цена) — ненулевые суммы, соответствующие выбранным опциям.

Если все пункты выполнены, цепочка от конфигурации до экспорта работает, а `breakdown` из конфигуратора доходит до Excel.

---

## Если автотест не запускается

- **`DATABASE_URL` / PostgreSQL:** скрипт требует БД. Задайте в `.env` корректный `DATABASE_URL=postgresql://...` и при необходимости выполните миграции и seed.
- **Нет клиентов:** выполните `npx prisma db seed` или создайте клиента вручную.
