# Конфигуратор /doors: все опции и связь с final_filled 30.01.xlsx и БД

## 1. Полный список опций на странице (каждая кнопка по вкладкам)

### Верхний уровень (всегда видны)
- **Кнопки стилей** — по одной на каждый уникальный стиль из моделей (из БД: `Domeo_Стиль Web`). Примеры: «Современные», «Классика», «Неоклассика», «Скрытая».
- **Табы:** ПОЛОТНО | ПОКРЫТИЕ И ЦВЕТ | ФУРНИТУРА | НАЛИЧНИКИ | ДОП ОПЦИИ.

---

### Вкладка «ПОЛОТНО»
- **Сетка моделей** — по одной кнопке-карточке на каждую модель (после фильтра по стилю). Данные: complete-data → `modelKey`, `model`, `photo`.
- **РАЗМЕРЫ**
  - **Ширина (мм):** кнопки по списку `widthOptions` (из размеров выбранной модели или дефолт 600, 700, 800, 900).
  - **Высота (мм):** кнопки по списку `heightOptions` (из размеров модели или дефолт 2000, 2100, …).
- **РЕВЕРСНЫЕ ДВЕРИ:** кнопки «Нет» | «Да» (`reversible`).
- **НАПОЛНЕНИЕ:** три кнопки — «Стандартное» (~27 дБ), «Хорошее» (~30 дБ), «Отличное» (35–42 дБ) — захардкоженный массив `fillingOptions`, не из БД.

---

### Вкладка «ПОКРЫТИЕ И ЦВЕТ»
- **ПОКРЫТИЕ:** кнопки по типам покрытия выбранной модели (`finishes`: ПЭТ, ПВХ, Шпон, Эмаль и т.д.) — из complete-data (БД).
- **МОНОХРОМНАЯ ПАЛИТРА** (при ПЭТ/ПВХ/Эмаль): сетка кнопок-цветов из `monochromeColors` (id, name, photo_path) — из `colorsByFinish[selectedFinish]` (БД, PropertyPhoto).
- **ДРЕВЕСНАЯ ПАЛИТРА** (при Шпон): сетка кнопок из `woodOptions` — те же данные по типу «Шпон».
- **АЛЮМИНИЕВАЯ КРОМКА:** кнопки «Без кромки» + по одной на каждый вариант из `edgeOptions` (из `edges` по модели; БД: свойства товаров «Кромка»).

---

### Вкладка «ФУРНИТУРА»
- **КОМПЛЕКТ ФУРНИТУРЫ:** сетка карточек комплектов. Сейчас рендер идёт по `[].map(...)` — **массив пустой** (TODO в коде). Ожидаемый источник: API `hardware?type=kits` (категория «Комплекты фурнитуры»).
- **РУЧКА:** одна кнопка «Выберите» / превью выбранной ручки; по клику открывается модальное окно выбора. Список ручек: `allHandles` из `hardware?type=handles` (БД).
- **ЗАВЕРТКА:** кнопки «Нет» | «Да» (`hasLock`) — только локальный state, в расчёт цены и в БД не передаётся.

---

### Вкладка «НАЛИЧНИКИ»
- **НАЛИЧНИК:** сетка кнопок по `architraveOptions` — из `allArchitraves` (API `hardware?type=architraves`, категория «Наличники»).  
  **Ошибка в коде:** при клике вызывается `setSelectedArchitraveId(architrave.name)` — сохраняется **название**, а в корзину и в расчёт цены должны уходить **id** (для `option_ids`). Нужно сохранять `architrave.id`.

---

### Вкладка «ДОП ОПЦИИ»
- **ОГРАНИЧИТЕЛИ:** кнопка «Без ограничителя» + по одной на каждый элемент `stopperOptions` (из `allLimiters` → API `hardware?type=limiters`). У каждого ограничителя подпись и подбор **цвета ограничителя** — четыре кружка: Черный, Белый, Хром, Золото (`stopperColors` захардкожены).
- **ЗЕРКАЛО:** кнопки из `mirrorOptions` — сейчас строятся из `options.filter(o => o.option_type === 'зеркало')`. **`options` всегда []** (не загружаются из БД), поэтому фактически только «Без зеркала».
- **ПОРОГ:** две кнопки «Нет» | «Да». При «Да» подставляется `thresholdOptions.find(o => o.option_type === 'порог')?.id`. **`thresholdOptions` из `options`** — тоже пустой.

---

### Правая колонка (всегда)
- **Превью двери** — изображение по выбранному цвету/модели.
- **Спецификация** — текст: Стиль, Модель, Размеры, Реверс, Наполнение, Покрытие и цвет, Кромка, Ручка, Наличник, Ограничитель, Зеркало, Порог.
- **Цена** — результат `POST /api/price/doors`.
- Кнопки **«В корзину»**, **«Заказать в 1 клик»**, **«КП» / «Счет» / «Заказ»** (с выбором клиента).

---

## 2. Файл final_filled 30.01.xlsx (фактическая структура)

Файл: **`1002/final_filled 30.01.xlsx`**. Структура получена скриптом `scripts/inspect-final-filled-xlsx.ts`.

**Листы:** Цены базовые, Цвет, Опции, Стекло_доступность, Наценка за кромку, Наличники, Фурнитура, 04 Ручки Завертки, 05 Ограничители.

**Столбцы по листам:**

- **Цены базовые:** Код модели Domeo (Web), Название модели, Стиль Domeo (Web), Поставщик, Высота мм, Ширины мм, Толщина мм, Тип покрытия, Стекло, Кромка в базе, Цена опт, Цена РРЦ.
- **Цвет:** Название модели, Поставщик, Тип покрытия, Цвет/отделка, Ссылка на обложку, Ссылки на галерею (через ;).
- **Опции:** Название модели, Поставщик, Название наполнения, Звукоизоляция (дБ), Надбавка 2301–2500мм (%), Надбавка 2501–3000мм (%), Реверс доступен (Да/Нет), Надбавка за реверс (руб), Порог доступен (Да/Нет), Цена порога (руб), Зеркало доступно (Да/Нет), Зеркало: Одна сторона (руб), Зеркало: Две стороны (руб).
- **Стекло_доступность:** Код модели Domeo (Web), Поставщик, Название модели, Доступные цвета стекол для модели.
- **Наценка за кромку:** Название модели, Кромка включена в базовую цену, Базовая кромка (Цвет), Опции кромки доступны, Наценка за кромку как за опцию, Цвет 2–4 и Наценка за Цвет 2–4.
- **Наличники:** Поставщик, Наличник: Название, Наличник: Описание, Наличник: Фото (ссылка).
- **Фурнитура:** Комплект фурнитуры: Название, Описание, Цена.
- **04 Ручки Завертки:** Тип (Ручка/Завертка), Название (Domeo_наименование для Web), Описание, Группа, Цена продажи/закупки/РРЦ (руб), Фото (ссылка), Порядок сортировки, Активна (Да/Нет), Завертка цена РРЦ, Фото завертки (ссылка).
- **05 Ограничители:** ID товара, Название, Тип (магнитный врезной / напольный / настенный), Описание, Цена опт/РРЦ (руб), Фото (путь).

По документации и коду импорта:

| Лист | Назначение | Импорт в БД |
|------|------------|-------------|
| **Цены базовые** | Модели, размеры, **тип покрытия**, базовая цена (Цена РРЦ) | Product (двери), один товар на комбинацию (код, размеры, тип покрытия), properties_data |
| **Цвет** | Модель + тип покрытия + цвет, ссылки на фото | PropertyPhoto (Domeo_Модель_Цвет) |
| **Опции** | Реверс, порог, зеркало, надбавки по высоте и т.д. | properties_data товаров дверей (по «Название модели») |
| **Стекло_доступность** | Доступные цвета стекол по модели | properties_data |
| **Наценка за кромку** | Варианты кромки и наценки по модели | properties_data |
| **Наличники** | Название, описание, фото | Product + ProductImage |
| **Фурнитура** | Комплекты фурнитуры | Product |
| **04 Ручки Завертки** | Ручки, фото, цена | Product + ProductImage |
| **05 Ограничители** | Ограничители, фото, цена | Product + ProductImage |

**Тип покрытия и базовая цена:** В листе «Цены базовые» у каждой строки указаны столбцы **Тип покрытия** и **Цена РРЦ**. Разные строки одной модели с разным типом покрытия (ПВХ, Эмаль, Шпон и т.д.) имеют разные цены. Импорт формирует SKU товара как `door_код_ширина_высота_покрытие`, поэтому в БД создаётся отдельная запись (и своя базовая цена) на каждую комбинацию модель + размеры + тип покрытия. Расчёт цены (`POST /api/price/doors`) по параметру `selection.finish` (тип покрытия) находит соответствующий товар и подставляет его `base_price` / Цена РРЦ.

**Важно:** В FINAL_FILLED_DATA_MAP указано, что в «Цены базовые» могут быть названия в стиле Юркас, а в «Цвет» и «Опции» — в стиле Фрамир; при несовпадении «Название модели» опции и цвета для модели в БД не подтягиваются.

---

## 3. Связь: Excel → БД → конфигуратор

| Опция в UI | Источник в конфигураторе | Откуда в БД | Лист Excel |
|------------|---------------------------|-------------|------------|
| Стили | complete-data → model.style | Product.properties_data['Domeo_Стиль Web'] | Цены базовые |
| Модели | complete-data (modelKey, photo) | Product + PropertyPhoto | Цены базовые, Цвет |
| Ширина/высота | complete-data → products[].properties | Product.properties_data | Цены базовые |
| Реверс | state только | — | Опции (Реверс доступен, надбавка) — в БД есть, в расчёт не передаётся |
| Наполнение | захардкожено | — | Опции (Звукоизоляция) — в БД есть, в UI не привязано к товару |
| Тип покрытия / цвет | complete-data (coatings, colorsByFinish) | PropertyPhoto, products | Цвет, Цены базовые |
| Кромка | complete-data (edges) | Product.properties_data['Кромка'] | Наценка за кромку, Цены базовые |
| Комплект фурнитуры | не загружается (пустой массив) | Product (Комплекты фурнитуры) | Фурнитура |
| Ручка | hardware?type=handles | Product + ProductImage | 04 Ручки Завертки |
| Завертка (Да/Нет) | state только | — | — |
| Наличник | hardware?type=architraves | Product + ProductImage | Наличники |
| Ограничитель | hardware?type=limiters | Product + ProductImage | 05 Ограничители |
| Зеркало | options (пусто) | Опции по модели в properties_data (зеркало одна/две стороны) | Опции |
| Порог | options (пусто) | Опции по модели (порог доступен, цена) | Опции |

---

## 3.1 Каскадная фильтрация по калькулятору

Порядок выбора и зависимости (каскад):

1. **Стиль** — выбирается первым; от него зависит список моделей. Источник: `complete-data` → уникальные `Domeo_Стиль Web` по товарам.
2. **Наполнение** — опциональный фильтр по моделям; отображаются только модели, у которых в опциях есть совпадающее «Название наполнения» (лист «Опции»).
3. **Модель** — выбирается из отфильтрованного списка (`filteredModels`). При смене стиля/наполнения выбранная модель сбрасывается на первую подходящую.
4. **Размеры (ширина × высота)** — варианты берутся из товаров выбранной модели (`products` в complete-data); при смене модели список размеров обновляется.
5. **Тип покрытия и цвет** — типы покрытия и палитра цветов привязаны к модели (лист «Цвет», PropertyPhoto по модели). При смене модели сбрасываются тип покрытия/цвет на первый доступный.
6. **Кромка** — варианты кромки по модели (из листа «Наценка за кромку» → properties_data товаров). При смене модели выбранная кромка сбрасывается, если её нет в списке опций новой модели.
7. **Цвет стекла** — только для моделей с опцией стекла (лист «Стекло_доступность»); при смене модели сбрасывается.
8. **Ручки, наличники, ограничители, зеркало, порог** — общие списки (API `hardware`, опции по модели); не фильтруются по стилю/модели.

Серверный API **GET /api/catalog/doors/cascade-options** (параметры: style, model, finish, color, type, width, height, edge) возвращает доступные значения для следующего шага по отфильтрованному набору товаров. В текущей реализации калькулятор использует в основном **complete-data** и клиентскую фильтрацию (стиль, наполнение → модели; модель → данные из API по этой модели). При необходимости каскадные опции с сервера можно подключать для валидации или дополнительного ограничения списков.

---

## 3.2 Один «Код модели Domeo (Web)» и несколько «Моделей» (фабричных названий)

В Excel и в БД у разных строк «Цены базовые» может быть **один и тот же** «Код модели Domeo (Web)» и **разные** «Название модели» / «Domeo_Название модели для Web» (фабричные названия). Текущая логика:

### Группировка в complete-data

- **Единица в UI (одна карточка модели)** = один **Код модели Domeo (Web)** (`modelKey`). Все товары с этим кодом попадают в одну запись модели: `modelMap.set(modelKey, { products: [...], factoryModelNames: Set<названия> })`.
- В списке моделей показывается **код** (`displayName = modelKey`), а не фабричное название.
- В одной модели собираются **все товары** (все комбинации размеров × покрытий) по всем фабричным названиям с этим кодом, и **все фабричные названия** в `factoryModelNames`.

### Дальнейшая фильтрация по этой модели

1. **Покрытия и цвета (лист «Цвет»)**  
   Варианты покрытий и цветов строятся по **всем** фабричным названиям этой модели: для каждого имени из `factoryModelNames` запрашиваются PropertyPhoto с `propertyValue`, начинающимся с «Название модели|». Результаты **объединяются** в один общий список покрытий/цветов (без дубликатов по паре тип покрытия + цвет). Итог: у одной модели (по коду) отображается **объединённый** набор покрытий и цветов по всем её фабричным названиям.

2. **Размеры (ширина × высота)**  
   Берутся из **всех** товаров этой модели (`modelData.products`): объединение всех комбинаций размеров по всем товарам с данным кодом.

3. **Опции по модели (реверс, зеркало, порог, наполнение, цвета стекла)**  
   Берутся **только из первого товара** в `modelData.products` (порядок товаров зависит от ответа БД). То есть реверс, зеркало, порог, наполнение и список цветов стекла показываются по одному из фабричных вариантов. Если у разных фабричных названий с одним кодом эти опции различаются, в UI будет отражён только один вариант (от «первого» товара).

4. **Кромки**  
   Собираются из **всех** товаров модели: по полю «Кромка» в `properties` всех товаров, уникальные значения объединяются в общий список опций кромки.

### Расчёт цены (POST /api/price/doors)

- В запрос передаётся **модель = код** (`selection.model = selectedModelId = modelKey`).
- В БД ищутся товары, у которых **либо** «Код модели Domeo (Web)» **либо** «Domeo_Название модели для Web» совпадает с переданным значением. То есть находятся **все** товары с этим кодом (и при необходимости с совпадающим фабричным названием).
- Из них по остальным параметрам (стиль, тип покрытия, цвет, ширина, высота и т.д.) выбираются подходящие товары. Если подходит несколько — берётся товар с **максимальной** ценой.
- Итоговая цена и надбавки (реверс, зеркало, порог) считаются по **найденному** товару. Таким образом, при одном коде и нескольких фабричных названиях фактическая цена и опции в расчёте могут относиться к другому фабричному варианту, чем тот, из которого взяты опции в UI (так как в UI опции взяты из первого товара в списке).

### Кратко

| Что | Источник при одном коде и нескольких «Моделях» |
|-----|------------------------------------------------|
| Список моделей в UI | Одна запись на код (код = modelKey). |
| Покрытия и цвета | Объединение по **всем** фабричным названиям (лист «Цвет»). |
| Размеры | Объединение по **всем** товарам с этим кодом. |
| Реверс / зеркало / порог / наполнение / стекло | Только из **первого** товара в массиве модели. |
| Кромки | Объединение по **всем** товарам модели. |
| Расчёт цены | По коду и выбранным параметрам выбирается **один** подходящий товар (при нескольких — с макс. ценой); по нему считаются цена и надбавки. |

**Текущая реализация (каскад):** Опции считаются по API **GET /api/catalog/doors/model-options**: опция доступна, если она есть **хотя бы у одного** товара в отфильтрованном наборе. После выбора реверса, наполнения, размера, покрытия или цвета последующие опции и списки (наполнение, размеры, покрытия, цвета, кромки) сужаются по этому набору. Фронт использует хук `useModelOptions` и подставляет полученные списки в UI.

**Отчёт по единственности цены:** Скрипт `scripts/report-models-non-unique-price.ts` проверяет, что при одинаковых параметрах (код, стиль, размер, покрытие, цвет) в БД не более одного товара с разной ценой. Результат записывается в `docs/MODELS_NON_UNIQUE_PRICE.md`. Запуск: `npx tsx scripts/report-models-non-unique-price.ts`.

---

## 4. Проверка: все ли данные из файла в БД

Чтобы проверить это строго, нужно:

1. **Иметь актуальный файл** `1002/final_filled 30.01.xlsx` и выгрузить из него список листов и столбцов (скрипт `scripts/inspect-final-filled-xlsx.ts`).
2. **После импорта** (`npx tsx scripts/import-final-filled.ts`) сравнить:
   - количество товаров по категориям в БД с количеством строк на листах Наличники, Фурнитура, 04 Ручки Завертки, 05 Ограничители;
   - количество товаров дверей с числом комбинаций (модель × размеры) из «Цены базовые»;
   - количество записей PropertyPhoto (Domeo_Модель_Цвет) с числом строк/фото из «Цвет».
3. **Совпадение названий моделей** между листами «Цены базовые», «Цвет», «Опции» — иначе часть опций и цветов не попадёт в товары (см. FINAL_FILLED_DATA_MAP.md).

Атрибуты: импорт из Excel пишет в Product (name, sku, base_price, properties_data, description), в ProductImage (url), в PropertyPhoto (categoryId, propertyName, propertyValue, photoPath). Проверка «все ли атрибуты на месте» — выборочным запросом к БД по одному товару из каждой категории и сверкой с соответствующей строкой Excel.

---

## 5. Логика расчёта и привязка к конфигуратору

- **Условие расчёта:** выбраны стиль, модель, ширина, высота, тип покрытия и цвет.
- **В selection уходят:** model, style, finish, color, width, height, handle.id, edge_id, limiter_id, option_ids.
- **В price/doors:** подбор товара двери по style, model, finish, color, width, height; добавление цены ручки, ограничителя и опций (по id) к итогу и в breakdown.
- **Ошибки/пробелы:**
  - Наличник: в UI сохраняется `architrave.name`, в корзину и в API нужно передавать `architrave.id` (и в option_ids подставлять id).
  - Зеркало/порог: в конфигураторе списки пустые (options не загружаются). Варианты: либо загружать опции по выбранной модели из properties_data товаров дверей (Domeo_Опции_*) и формировать mirrorOptions/thresholdOptions как виртуальные опции с id товара или условным id, либо завести отдельные сущности в БД.
  - Реверс и наполнение: не передаются в API цены; при необходимости нужно брать из properties_data (Domeo_Опции_Реверс_доступен, надбавка за реверс, звукоизоляция) и учитывать в расчёте.
  - Комплект фурнитуры: на странице не подставляется список комплектов из API; нужно вызывать `hardware?type=kits` и рендерить карточки, передавать выбранный kit в selection и учитывать в price/doors (уже есть ветка по hardware_kit).

---

## 6. Вопросы к вам

1. **Файл `1002/final_filled 30.01.xlsx`** — он у вас физически лежит в `C:\01_conf\1002doors\1002`? Если да, можно запустить `npx tsx scripts/inspect-final-filled-xlsx.ts` и прислать вывод (или вставить сюда список листов и столбцов).

2. **Зеркало и порог** — в Excel это не отдельные товары, а опции по модели (цена «одна сторона» / «две стороны», «порог доступен», «цена порога»). Устраивает ли вариант: не отдельные товары в каталоге, а при выборе «Зеркало: Да» / «Порог: Да» брать цену из properties_data выбранного товара двери (Domeo_Опции_*) и добавлять в расчёт на бэкенде? Или нужны отдельные позиции в каталоге (например, категория «Опции дверей»)?

3. **Наличник:** при выборе в UI сейчас сохраняется название; в корзину и в расчёт цены должны уходить id товара наличника. Подтверждаете, что правим на сохранение и передачу `architrave.id`?

4. **Комплект фурнитуры** — нужно ли в ближайшей версии подгружать список комплектов с API и показывать выбор в конфигураторе, или это отложено?

5. **Реверс и наполнение** — должны ли влиять на итоговую цену (надбавка за реверс, разные цены по наполнению)? Если да, нужно передавать их в selection и доработать price/doors.

6. **Цвет ограничителя** (Черный/Белый/Хром/Золото) — сейчас только в UI; нужно ли сохранять его в корзину и в заказ и как (отдельное поле или часть названия ограничителя)?

Ответы на эти вопросы зададут, что именно править в логике расчёта и привязке данных конфигуратора к БД и Excel.

---

## 7. Решения и скрипт проверки Excel ↔ БД

- **Зеркало и порог** — не отдельные товары; опции, влияют на цену, в корзине отдельной строкой не отображаются. Цена берётся из опций модели (Domeo_Опции_*) и добавляется в breakdown.
- **Комплекты фурнитуры** — загружаются в конфигураторе (API `hardware?type=kits`), отображаются во вкладке «Фурнитура», передаются в расчёт цены и в корзину.
- **Реверс** — влияет на цену (надбавка из опций модели). **Название наполнения** — только фильтр по моделям (связь между листами по «Название модели»).
- **Ограничитель** — отдельный товар, отдельная строка в корзине.
- **Проверка «все данные из Excel в БД»:** скрипт `scripts/verify-excel-db-and-links.ts`:
  - Сравнивает количество строк по листам Excel с количеством записей в БД.
  - Проверяет связи по «Название модели» между «Цены базовые», «Цвет», «Опции», «Наценка за кромку», «Стекло_доступность».
  - Выводит модели без связей и рекомендацию вынести на обсуждение: унифицировать названия или добавить слияние по коду модели в импорте.
  - Запуск: `npx tsx scripts/verify-excel-db-and-links.ts`
