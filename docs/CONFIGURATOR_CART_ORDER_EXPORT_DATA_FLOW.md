# Цепочка данных: конфигуратор → корзина → заказ → экспорт

## Идея

При конфигурации дверей и опций **под капотом** собирается массив «выбранные варианты + цена за опцию». Этот массив передаётся в корзину, затем в заказ, затем используется в экспорте — один источник правды, без потери данных.

---

## 1. Конфигуратор (страница дверей)

**Где:** `app/doors/page.tsx`, функция `addToCart`.

При расчёте цены через API (`/api/price/doors`) возвращается:
- `breakdown` — массив `{ label: string; amount: number }`: разбивка суммы по строкам (Дверь, Реверс, Кромка, Порог, Наличники, Ручка, Завертка, Ограничитель и т.д.).
- `matchingVariants` — подходящие варианты из БД (для экспорта без повторного поиска).

В корзину кладётся позиция двери с полями:
- `breakdown: priceData.breakdown ?? []` — **все выбранные опции и цены по ним**;
- `matchingVariants: priceData.matchingVariants ?? []`;
- `specRows` — человекочитаемая спецификация (Стиль, Полотно, Размеры, Покрытие и т.д.);
- остальные поля: model, finish, color, width, height, threshold, optionIds, architraveNames, unitPrice, handleId, limiterId и т.д.

То есть **breakdown** — это и есть «массив выбранных вариантов и цен за опцию», собранный в конфигураторе.

---

## 2. Корзина

**Где:** состояние корзины на странице дверей (и в CartManager).

Элементы корзины хранят те же поля, что и при добавлении: `breakdown`, `matchingVariants`, `specRows`, все опции двери. Ничего не отбрасывается.

---

## 3. Создание заказа (CartManager)

**Где:** `components/doors/CartManager.tsx`, при создании заказа (кнопка «Создать заказ» и т.п.).

При формировании тела запроса `POST /api/orders` элементы корзины маппятся в `items`. В каждый элемент **обязательно** передаётся:
- `breakdown: item.breakdown` — разбивка цены по опциям из конфигуратора;
- все остальные поля (model, model_name, matchingVariants, qty, unitPrice, specRows, edge, threshold, optionIds, architraveNames и т.д.).

Без этого поля `breakdown` в заказе не сохранялся бы и в экспорте не было бы данных для колонок «опция, цена».

---

## 4. Хранение в заказе и счёте

**Где:** `lib/repositories/document.repository.ts`, `createOrder` / `createInvoice`.

- При создании заказа: `cart_data = JSON.stringify(data.items)`. В `items` уже есть `breakdown` и остальные поля.
- При создании счёта (Invoice): в `cart_data` счёта сохраняются те же полные `items` (если API/фронт передаёт их из заказа или из формы).

В итоге в `order.cart_data` и при необходимости в `invoice.cart_data` лежит полный состав позиций с `breakdown` и всеми опциями.

---

## 5. Экспорт (Excel)

**Где:** `lib/export/puppeteer-generator.ts` (generateExcelOrder), `lib/export/excel-door-fields.ts` (getDoorFieldValue, getOptionPriceFromBreakdown).

При экспорте заказа в Excel:
- Данные для строк таблицы берутся из `cart_data` (из счёта или заказа): каждая позиция — это объект с `breakdown`, `model`, `width`, `height`, `unitPrice` и т.д.
- Для колонок вида «X, цена» (Кромка, цена; Реверс, цена; Порог, цена; Наличники, цена; Комплект фурнитуры, цена) используется `item.breakdown`: по меткам (label) из breakdown выбирается нужная строка и подставляется сумма (`getOptionPriceFromBreakdown`).
- Остальные колонки заполняются из полей позиции и из свойств товара БД (если есть совпадение).

Таким образом, **все выбранные опции и цены за опцию**, собранные в конфигураторе в `breakdown`, доходят до экспорта и используются для заполнения колонок Excel.

---

## Итог

| Этап            | Что передаётся |
|-----------------|----------------|
| Конфигуратор   | `breakdown`, `matchingVariants`, `specRows` + все опции двери в объекте позиции |
| Корзина        | Те же поля без изменений |
| Заказ (API)    | `items` с полем `breakdown` и остальными полями (CartManager передаёт `item.breakdown`) |
| order.cart_data | JSON с полным массивом `items` |
| Экспорт Excel  | Чтение `cart_data`, для каждой позиции использование `item.breakdown` и полей для заполнения всех колонок |

Дополнительный массив «options with prices» с явными ключами колонок (например, `optionKey: "Порог, цена"`) при необходимости можно ввести позже и собирать его в конфигураторе из того же `breakdown`, чтобы в экспорте не разбирать по меткам. Текущей схемы с `breakdown` достаточно, чтобы все опции и цены доходили до экспорта и заполнялись в Excel.
