# Диагностика «цена не считается» в конфигураторе дверей

## Как поймать проблему

### 1. В браузере (при воспроизведении)

1. Откройте страницу дверей (например `/doors`), откройте консоль (F12 → Console).
2. Выберите стиль, модель, размеры, наполнение, покрытие и цвет так, чтобы цена не появилась (осталась «—»).
3. В консоли появятся сообщения:
   - **`[Цена не найдена] Параметры запроса:`** — что именно ушло в API (model, style, finish, color, width, height, filling).
   - **`[Цена не найдена] Диагностика API:`** — ответ сервера с полем `debug`:
     - `selection` — параметры запроса;
     - `productsCount` — сколько всего товаров дверей в БД;
     - **`filterSteps`** — на каком шаге фильтра отсеиваются все товары:
       - `model+style+finish+color+size+filling (exact)` — строгое совпадение по всем полям (в т.ч. цвет);
       - `+ allowEmptyColor` — разрешён товар без цвета в БД;
       - `+ finish optional` — без обязательного типа покрытия;
       - `+ style optional` — без обязательного стиля.

По `filterSteps` видно, на каком условии «ломается» подбор: если на exact 0, а на allowEmptyColor уже есть совпадения — не совпадает **цвет** (в БД у товара другой цвет или пусто). Если на exact и allowEmptyColor оба 0, а на finish optional есть — не совпадает **покрытие или цвет** и т.д.

### 2. Тест скриптом (по БД)

Требуется `.env` с `DATABASE_URL` (PostgreSQL).

```bash
npx tsx scripts/test-price-doors.ts
```

Скрипт берёт комбинации (модель, стиль, покрытие, цвет, размер, наполнение) из товаров и проверяет каждую через движок цен. В выводе:
- сколько комбинаций дали цену, сколько — нет;
- для первых 5 «not found» — полная диагностика по шагам фильтра;
- сводка: на каком шаге чаще всего отсев.

### 3. Тест через API

При запущенном dev-сервере (`npm run dev`):

```bash
npx tsx scripts/test-price-doors.ts --api
```

Один запрос уходит в `POST /api/price/doors`; в ответе при notFound в dev будет поле `debug` с теми же `filterSteps`.

## Типичные причины «цена не считается»

1. **Цвет не совпадает**  
   В интерфейсе цвет берётся из PropertyPhoto (например «Emlayer серый»), а в товаре в БД поле «Цвет/Отделка» другое (другое написание, регистр или пусто).  
   *Что смотреть:* в debug смотреть `filterSteps`: если при exact 0, а при allowEmptyColor > 0 — проблема в цвете.

2. **Нет товара с такой комбинацией**  
   После отката/очистки в БД могло не остаться товара с выбранными моделью, покрытием, цветом и размером.  
   *Что смотреть:* `productsCount` и `filterSteps` — на каком шаге счётчик впервые становится 0.

3. **Наполнение или размер**  
   В каталоге есть «Сильвер», а в товаре — другое значение наполнения; или выбранный размер (ширина/высота) ни у одного товара не совпадает.  
   *Что смотреть:* в `filterSteps` смотреть, когда именно count падает до 0 (после добавления finish/color/size/filling).

4. **Стиль**  
   Реже: в БД у товара другой «Domeo_Стиль Web», чем выбранный в UI.  
   *Что смотреть:* если при «style optional» появляются совпадения, а при exact — нет, причина в стиле.

После прогона тестов или воспроизведения в браузере по этим полям можно однозначно сказать, какое поле (цвет, покрытие, размер, наполнение, стиль) не даёт подобрать товар.
