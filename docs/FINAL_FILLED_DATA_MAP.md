# Карта данных final_filled 30.01.xlsx → БД и калькулятор

Документ описывает **каждую вкладку и каждый столбец** файла, куда данные попадают в БД, как используются в калькуляторе и как связаны листы между собой.

---

## 1. Сводка по вкладкам

| Вкладка | Строк | Импорт в БД | Связь с другими листами |
|---------|-------|-------------|--------------------------|
| Цены базовые | 504 | Product (двери), properties_data | Ключ слияния: «Название модели». Опции, Стекло, Кромка подтягиваются по нему. |
| Цвет | 863 | PropertyPhoto (Domeo_Модель_Цвет) | Связь только по **точному совпадению «Название модели»** с «Цены базовые» (100%). |
| Опции | 148 | properties_data товаров дверей | По «Название модели». **В файле названия Фрамир («Дверное полотно A-Line…») — не совпадают с Цены базовые (Юркас «ДПГ Флекс…»).** |
| Стекло_доступность | 86 | properties_data (Domeo_Стекло_доступность) | По «Название модели». Есть столбец «Код модели Domeo (Web)» — можно слияние по коду (см. раздел 7). |
| Наценка за кромку | 72 | properties_data (Domeo_Кромка_*) | По «Название модели». Совпадает с «Цены базовые» (те же названия). |
| Наличники | 17 | Product + ProductImage | Независимый лист. |
| Фурнитура | 3 | Product | Независимый лист. |
| 04 Ручки Завертки | 124 | Product + ProductImage | Независимый лист. |
| 05 Ограничители | 25 | Product + ProductImage | Независимый лист. |

---

## 2. Цены базовые (504 строки)

**Назначение:** Один ряд = одна базовая цена на комбинацию (код модели, размеры, тип покрытия и т.д.). Из этих строк импорт разворачивает **отдельные товары** по каждой паре (ширина × высота).

| Столбец | Импорт | Куда в БД | Использование в калькуляторе / фильтрах |
|---------|--------|-----------|----------------------------------------|
| Код модели Domeo (Web) | ✓ | properties_data, sku (часть) | Фильтр модели (model), поиск товара по коду. |
| Название модели | ✓ | name, properties_data (Название модели, Domeo_Название модели для Web) | Отображение модели, фильтр «модель», слияние с Опции/Стекло/Кромка. |
| Стиль Domeo (Web) | ✓ | properties_data (Стиль Domeo (Web), Domeo_Стиль Web) | Фильтр «стиль» (первый шаг в конфигураторе). |
| Поставщик | ✓ | properties_data | Справочно. |
| Высота, мм | ✓ | Парсинг списка → цикл по высотам; properties_data['Высота/мм'] | Фильтр «высота», расчёт цены (подбор товара по размеру). |
| Ширины, мм | ✓ | Парсинг списка → цикл по ширинам; properties_data['Ширина/мм'] | Фильтр «ширина», расчёт цены. |
| Толщина, мм | ✓ | properties_data | Справочно. |
| Тип покрытия | ✓ | properties_data['Тип покрытия'] | Фильтр «покрытие» (finish), подбор цены. |
| Стекло | ✓ | properties_data['Стекло'] | Справочно. |
| Кромка в базе | ✓ | properties_data['Кромка в базе'] | Справочно; детали кромки — из листа «Наценка за кромку». |
| Цена опт | ✓ | properties_data['Цена опт'] | Справочно. |
| Цена РРЦ | ✓ | properties_data['Цена РРЦ'], base_price | **Основная цена двери** в расчёте (POST /api/price/doors). |

**Связь:** По полю **«Название модели»** к одной строке «Цены базовые» подтягиваются:
- первая подходящая строка из **Опции** (все поля опций в properties_data);
- список из **Стекло_доступность** (Domeo_Стекло_доступность);
- одна строка из **Наценка за кромку** (все поля кромки в properties_data).

**Важно:** В «Цены базовые» в сэмпле — названия в стиле Юркас («ДПГ Флекс Эмаль Порта ПТА-50 B»). В «Опции» и «Цвет» — в стиле Фрамир («Дверное полотно A-Line 1 ПО»). Где названия не совпадают, опции и стекло для этой модели в БД не попадут (см. раздел 7).

---

## 3. Цвет (863 строки)

**Назначение:** Фото обложки и галереи для комбинации (модель + тип покрытия + цвет). Хранятся в **PropertyPhoto**, не в полях товара.

| Столбец | Импорт | Куда в БД | Использование в калькуляторе |
|---------|--------|-----------|------------------------------|
| Название модели | ✓ | propertyValue (часть ключа «модель\|тип\|цвет») | **Должно на 100% совпадать с «Цены базовые»** — по нему строится связь модель ↔ стили и цвета. |
| Поставщик | ✗ | — | Не импортируется. При необходимости — в properties или отдельная таблица. |
| Тип покрытия | ✓ | propertyValue | Группировка цветов по типу покрытия (finishes → colorsByFinish). |
| Цвет/отделка | ✓ | propertyValue | Название варианта цвета, превью. |
| Ссылка на обложку | ✓ | PropertyPhoto.photoPath, photoType=cover | Обложка в карточке модели/цвета. |
| Ссылки на галерею (через ;) | ✓ | PropertyPhoto, photoType=gallery_1, gallery_2, … | Галерея изображений. |

**Связь:** **Название модели во вкладках «Цены базовые» и «Цвет» должно совпадать на 100%.** Связь «модель → доступные стили и цвета» строится только по точному совпадению поля «Название модели»: в API конфигуратора цвета и фото подставляются только для записей PropertyPhoto, у которых `propertyValue` начинается с `Название модели|` из «Цены базовые». Подстановка цветов по одному только типу покрытия не используется.

---

## 4. Опции (148 строк)

**Назначение:** Доп. опции по модели (реверс, порог, зеркало, надбавки по высоте и т.д.). При импорте берётся **первая** строка по «Название модели» и пишется в properties_data товаров дверей.

| Столбец | Импорт | Куда в БД (properties_data) | Использование в калькуляторе |
|---------|--------|-----------------------------|------------------------------|
| Название модели | ✓ (ключ слияния) | — | Связь с «Цены базовые». |
| Поставщик | ✗ | — | — |
| Название наполнения | ✗ | — | Можно добавить в properties. |
| Звукоизоляция (дБ) | ✓ | Domeo_Опции_Звукоизоляция_дБ | Отображение/фильтр. |
| Надбавка 2301-2500мм (%) к высоте 2000 | ✓ | Domeo_Опции_Надбавка_2301_2500_процент | Надбавки к цене по высоте (логика в калькуляторе/формулах). |
| Надбавка 2501-3000мм (%) к высоте 2000 | ✓ | Domeo_Опции_Надбавка_2501_3000_процент | Аналогично. |
| Реверс доступен (Да/Нет) | ✓ | Domeo_Опции_Реверс_доступен | Условие показа/расчёта реверса. |
| Надбавка за реверс (руб) | ✓ | Domeo_Опции_Надбавка_реверс_руб | Надбавка к цене. |
| Порог доступен (Да/Нет) | ✓ | Domeo_Опции_Порог_доступен | Условие показа порога. |
| Цена порога (руб) | ✓ | Domeo_Опции_Цена_порога_руб | Цена опции. |
| Зеркало доступно (Да/Нет) | ✓ | Domeo_Опции_Зеркало_доступно | Условие показа зеркала. |
| Зеркало: Одна сторона (руб) | ✓ | Domeo_Опции_Зеркало_одна_сторона_руб | Цена. |
| Зеркало: Две стороны (руб) | ✓ | Domeo_Опции_Зеркало_две_стороны_руб | Цена. |

**Связь:** Только по **«Название модели»**. В файле в «Опции» — названия Фрамир («Дверное полотно A-Line 1 ПО»), в «Цены базовые» — Юркас («ДПГ Флекс…»). Для таких моделей опции в товары не попадут. Рекомендация: в Excel добавить столбец «Код модели Domeo (Web)» и в импорте слияние делать по коду (или по обоим полям).

---

## 5. Стекло_доступность (86 строк)

| Столбец | Импорт | Куда в БД | Использование |
|---------|--------|-----------|----------------|
| Код модели Domeo (Web) | ✓ (есть в файле) | Не используется при слиянии | Можно использовать как ключ слияния с «Цены базовые». |
| Поставщик | ✗ | — | — |
| Название модели | ✓ (ключ слияния) | — | Сейчас слияние только по нему. |
| Доступные цвета стекол для модели | ✓ | properties_data['Domeo_Стекло_доступность'] (массив) | Список вариантов стекла по модели. |

**Связь:** Импорт строит `glassByModel` по «Название модели». В листе есть «Код модели Domeo (Web)» — логично добавить слияние по коду с «Цены базовые», чтобы стекло подтягивалось и для моделей Юркас.

---

## 6. Наценка за кромку (72 строки)

| Столбец | Импорт | Куда в БД | Использование |
|---------|--------|-----------|----------------|
| Название модели | ✓ (ключ) | — | Слияние с «Цены базовые» (названия совпадают). |
| Кромка включена в базовую цену (Да/Нет) | ✓ | Domeo_Кромка_в_базе_включена | Логика «кромка в базе» / доплата. |
| Базовая кромка (самая дешевая), Цвет | ✓ | Domeo_Кромка_базовая_цвет | Отображение, фильтр кромки. |
| Опции кромки доступны (Да/Нет) | ✓ | Domeo_Кромка_опции_доступны | Условие показа опций кромки. |
| Наценка за кромку как за опцию | ✓ | Domeo_Кромка_наценка_как_опция | Цена/наценка. |
| Цвет 2–4, Наценка за Цвет 2–4 | ✓ | Domeo_Кромка_Цвет_2–4, Domeo_Кромка_Наценка_Цвет_2–4 | Варианты кромки и надбавки. |

**Связь:** По «Название модели»; в файле совпадает с «Цены базовые» — слияние работает.

**Примечание:** В cascade-options фильтр по кромке смотрит на свойства «Кромка» и «Стоимость надбавки за кромку». В импорте мы пишем Domeo_Кромка_*. Если в UI используется «Кромка», нужно либо дублировать в «Кромка» из базовой/выбранной опции, либо поменять фильтр на Domeo_Кромка_*.

---

## 7. Наличники (17 строк)

| Столбец | Импорт | Куда в БД | Использование |
|---------|--------|-----------|----------------|
| Поставщик | ✗ | — | Можно сохранить в properties_data. |
| Наличник: Название | ✓ | Product.name, sku | Каталог наличников, выбор в конфигураторе. |
| Наличник: Описание | ✓ | Product.description | Описание. |
| Наличник: Фото (ссылка) | ✓ | ProductImage.url | Превью. |

---

## 8. Фурнитура (3 строки)

| Столбец | Импорт | Куда в БД | Использование |
|---------|--------|-----------|----------------|
| Комплект фурнитуры: Название | ✓ | Product.name, sku | Название комплекта (API hardware: name из props или name). |
| Описание | ✓ | Product.description | Описание. |
| Цена | ✓ | Product.base_price | Цена комплекта; в API — base_price или props['Группа_цена']. |

В API комплектов ожидаются при необходимости: «Наименование для Web», «Группа_цена», «Ценовая группа» — сейчас подставляются name и base_price.

---

## 9. 04 Ручки Завертки (124 строки)

| Столбец | Импорт | Куда в БД | Использование |
|---------|--------|-----------|----------------|
| Тип (Ручка/Завертка) | ✓ | properties_data | Фильтр/отображение. |
| Название (Domeo_наименование для Web) | ✓ | Product.name, sku | Название ручки в конфигураторе и расчёте цены. |
| Описание | ✓ | Product.description | Описание. |
| Группа | ✓ | properties_data | Группировка в UI (Базовый и т.д.). |
| Цена продажи (руб) | ✗ | — | Можно в properties. |
| Цена закупки (руб) | ✗ | — | Можно в properties. |
| Цена РРЦ (руб) | ✓ | Product.base_price | **Цена ручки в расчёте** (handle). |
| Фото (ссылка) | ✓ | ProductImage (is_primary) | Превью. |
| Порядок сортировки | ✗ | — | Можно в sort_order или properties. |
| Активна (Да/Нет) | ✓ | Product.is_active | Показ только активных. |
| Завертка, цена РРЦ | ✓ | properties_data | Для расчёта/отображения завертки. |
| Фото завертки (ссылка) | ✓ | ProductImage (второе) | Превью завертки. |

В API ручек цена берётся из base_price (и при наличии — из props['Domeo_цена группы Web']).

---

## 10. 05 Ограничители (25 строк)

| Столбец | Импорт | Куда в БД | Использование |
|---------|--------|-----------|----------------|
| ID товара | ✗ | — | В сэмпле пусто. |
| Название | ✓ | Product.name, sku | Название в каталоге и конфигураторе. |
| Тип (магнитный врезной / напольный / настенный) | ✓ | properties_data | Фильтр по типу. |
| Описание | ✓ | Product.description | Описание. |
| Цена опт (руб) | ✗ | — | Можно в properties. |
| Цена РРЦ (руб) | ✓ | Product.base_price | Цена в расчёте (ограничитель). |
| Фото (путь) | ✓ | ProductImage.url | Превью. |

---

## 11. Как данные используются в калькуляторе

### 11.1 Цепочка выбора (фильтры)

1. **Стиль** → из «Цены базовые»: `Domeo_Стиль Web` (complete-data, cascade-options).
2. **Модель** → из «Цены базовые»: `Domeo_Название модели для Web` или `Код модели Domeo (Web)` (complete-data, price/doors).
3. **Тип покрытия (finish)** → из «Цены базовые»: `Тип покрытия`; варианты цветов по типу — из **PropertyPhoto** (Цвет) → `colorsByFinish`.
4. **Цвет** → визуал и превью из PropertyPhoto; в товаре поля «Цвет» может не быть (один товар = одна размерность + один тип покрытия).
5. **Ширина / Высота** → из «Цены базовые»: `Ширина/мм`, `Высота/мм` (cascade-options, price/doors).
6. **Кромка** → из «Наценка за кромку»: Domeo_Кромка_* в properties_data; в cascade-options сейчас смотрят на «Кромка» и «Стоимость надбавки за кромку» (см. п. 6).
7. **Ручка** → категория «Ручки и завертки», Product.id + base_price (price/doors).
8. **Комплект фурнитуры** → категория «Комплекты фурнитуры», Product.id + base_price (price/doors).
9. **Ограничитель** → категория «Ограничители», Product + base_price (при подключении в расчёте).

### 11.2 Расчёт цены (POST /api/price/doors)

- **Дверь:** поиск товара по стилю, модели, типу покрытия, цвету (если есть), ширине, высоте; цена из `Цена РРЦ` или base_price.
- **Ручка:** по handle.id из категории «Ручки и завертки» — base_price (или props).
- **Комплект фурнитуры:** по hardware_kit.id из категории «Комплекты фурнитуры» — base_price (или props).
- Надбавки за реверс, порог, зеркало, высоту, кромку — из properties_data (Domeo_Опции_*, Domeo_Кромка_*); при необходимости формула цены должна их учитывать.

### 11.3 API, откуда конфигуратор берёт данные

- **Модели, покрытия, цвета, размеры:** GET /api/catalog/doors/complete-data (Product + PropertyPhoto, colorsByFinish по типу покрытия).
- **Каскадные фильтры:** GET /api/catalog/doors/cascade-options (стиль → модель → покрытие → цвет → размеры → кромка).
- **Цена:** POST /api/price/doors (selection: model, style, finish, color, width, height, handle, hardware_kit).
- **Ручки/комплекты:** GET /api/catalog/hardware?type=handles|kits.

---

## 12. Связи между листами (ключи)

```
Цены базовые [Название модели, Код модели Domeo (Web)]
    │
    ├── Опции [Название модели]  — совпадает только если одинаковые названия (Фрамир ≠ Юркас)
    ├── Стекло_доступность [Название модели или Код модели]  — по коду можно связать с Цены базовые
    └── Наценка за кромку [Название модели]  — совпадает с Цены базовые

Цвет [Название модели, Тип покрытия, Цвет/отделка]
    └── Связь с моделью: **только по точному совпадению «Название модели»** с «Цены базовые»
```

**Рекомендации по данным и импорту:**

1. **Опции:** В листе «Опции» добавить столбец «Код модели Domeo (Web)» и в импорте слияние с «Цены базовые» делать по коду (или сначала по коду, при отсутствии — по названию).
2. **Стекло_доступность:** В импорте дополнительно строить слияние по «Код модели Domeo (Web)» с «Цены базовые», чтобы стекло было и у моделей с другими названиями.
3. **Цвет:** Связь модель ↔ цвета только по точному совпадению «Название модели» в «Цены базовые» и «Цвет». В Excel нужно обеспечить одинаковые названия в обеих вкладках; при импорте выводятся предупреждения о несовпадениях.
4. **Кромка в UI:** Уточнить, откуда фильтр берёт «Кромка» и «Стоимость надбавки» — из Domeo_Кромка_* или отдельного поля; при необходимости заполнять их при импорте из «Наценка за кромку».
5. **Наличники:** При необходимости фильтра по поставщику — импортировать «Поставщик» в properties_data.
6. **Ручки:** «Порядок сортировки» и при необходимости «Цена продажи»/«Цена закупки» — в properties или sort_order для единообразия с Excel.

После этих уточнений все данные из final_filled 30.01.xlsx будут однозначно попадать в БД и использоваться в калькуляторе и фильтрах так, как задумано.
