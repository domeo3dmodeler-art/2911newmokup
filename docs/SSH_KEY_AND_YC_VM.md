# Безопасная работа с SSH-ключом и деплой на Yandex Cloud ВМ

## Новая ВМ: 158.160.74.180

Для выкладки проекта на ВМ Yandex Cloud с IP **158.160.74.180** используйте тот же подход, что и для staging (158.160.72.3): ключ не хранить в репозитории, подключаться по ключу, в скриптах — путь из переменной окружения.

---

## Как безопасно работать с SSH-ключом

### 1. Хранение ключа

- **Не коммитить** приватный ключ в git и не класть в папку проекта.
- Хранить ключ **вне репозитория**, например:
  - `C:\Users\<ваш_логин>\.ssh\id_ed25519` (или `id_rsa`) — стандартное место, подходит для любой ВМ;
  - либо отдельная папка вроде `C:\02_conf\ssh1702\...`, если ключ выдан консолью Yandex Cloud.
- Файл ключа должен быть **только у вас**: права доступа так, чтобы читать мог только владелец.

### 2. Права на файл ключа (Windows)

Если SSH пишет `WARNING: UNPROTECTED PRIVATE KEY FILE`, ограничьте доступ:

```powershell
# Один раз для вашего ключа (подставьте свой путь):
icacls "C:\Users\petr2\.ssh\id_ed25519" /inheritance:r /grant:r "%USERNAME%:R"
```

Для ключа из папки Yandex (если используете):

```powershell
icacls "C:\путь\к\приватному\ключу" /inheritance:r /grant:r "%USERNAME%:R"
```

### 3. Подключение без пароля: SSH config

Настройте `~/.ssh/config`, чтобы не указывать ключ и пользователя вручную и не хранить путь в скриптах.

**Пример для ВМ 158.160.74.180:**

Файл `C:\Users\<ваш_логин>\.ssh\config`:

```
Host domeo-yc
    HostName 158.160.74.180
    User ubuntu
    IdentityFile C:\Users\petr2\.ssh\id_ed25519
```

Если на ВМ пользователь не `ubuntu`, а например `petr`:

```
Host domeo-yc
    HostName 158.160.74.180
    User petr
    IdentityFile C:\Users\petr2\.ssh\id_ed25519
```

После этого:

```bash
ssh domeo-yc
```

Ключ и пользователь подставятся автоматически, путь к ключу не нужно писать в репозитории.

### 4. Скрипты деплоя: переменная окружения

Чтобы не хардкодить путь к ключу в скриптах (и не светить его в git), используется переменная окружения.

**Один раз задайте (PowerShell, для текущей сессии):**

```powershell
$env:1002DOORS_SSH_KEY = "C:\Users\petr2\.ssh\id_ed25519"
```

**Постоянно (для вашего пользователя):**

1. Win+R → `sysdm.cpl` → вкладка «Дополнительно» → «Переменные среды».
2. В «Переменные среды пользователя» нажмите «Создать»:
   - Имя: `1002DOORS_SSH_KEY`
   - Значение: полный путь к файлу приватного ключа, например `C:\Users\petr2\.ssh\id_ed25519`.

Либо в PowerShell (запись в профиль пользователя):

```powershell
[System.Environment]::SetEnvironmentVariable("1002DOORS_SSH_KEY", "C:\Users\petr2\.ssh\id_ed25519", "User")
```

Скрипты деплоя сначала смотрят `$env:1002DOORS_SSH_KEY`; если переменная не задана — используют запасной путь (например старый staging), чтобы не ломать уже настроенные окружения.

### 5. Добавление ключа на новую ВМ 158.160.74.180

При создании ВМ в Yandex Cloud можно сразу указать ваш публичный ключ. Если ВМ уже создана с паролем или другим ключом:

1. Подключитесь к ВМ (консоль Yandex Cloud в браузере или текущий ключ/пароль).
2. Вставьте вашу **публичную** часть ключа в `~/.ssh/authorized_keys` пользователя, под которым будете заходить:

```bash
mkdir -p ~/.ssh
echo "содержимое id_ed25519.pub или .pub файла" >> ~/.ssh/authorized_keys
chmod 700 ~/.ssh
chmod 600 ~/.ssh/authorized_keys
```

3. Проверьте вход с вашей машины: `ssh domeo-yc` (если настроили config выше).

### 6. Краткий чеклист

- [ ] Приватный ключ лежит вне репозитория (например `~/.ssh/` или отдельная папка).
- [ ] На ключ выставлены права «только владелец» (на Windows — через `icacls`).
- [ ] В `~/.ssh/config` есть хост для 158.160.74.180 (например `domeo-yc`), тогда `ssh domeo-yc` работает без указания ключа в командной строке.
- [ ] Для скриптов задана переменная `1002DOORS_SSH_KEY` с путём к тому же ключу (или скрипты используют fallback).
- [ ] Публичный ключ добавлен в `authorized_keys` на ВМ 158.160.74.180.

---

## Деплой на 158.160.74.180

После настройки ключа задайте переменные окружения **один раз** (или в профиле PowerShell / в «Переменные среды» пользователя):

```powershell
$env:1002DOORS_SSH_KEY = "C:\Users\petr2\.ssh\id_ed25519"   # путь к вашему ключу
$env:1002DOORS_STAGING_HOST = "ubuntu@158.160.74.180"       # или petr@158.160.74.180 — как на ВМ
```

Дальше все скрипты (`deploy-local-to-staging.ps1`, `restart-staging-app.ps1`, `reboot-staging-vm.ps1` и т.д.) будут использовать эту ВМ и этот ключ. Путь к ключу и IP не попадают в репозиторий.

На самой ВМ нужно установить Node.js 20, PostgreSQL, склонировать репозиторий в `~/1002doors`, настроить `.env`, выполнить сборку и запуск — пошагово это описано в [SETUP_YC_VM_STEP_BY_STEP.md](./SETUP_YC_VM_STEP_BY_STEP.md). В группе безопасности Yandex Cloud должны быть открыты входящие порты 22 (SSH) и 3000 (приложение).

Подробнее об инфраструктуре — в [DEPLOY_YANDEX_CLOUD.md](./DEPLOY_YANDEX_CLOUD.md).
