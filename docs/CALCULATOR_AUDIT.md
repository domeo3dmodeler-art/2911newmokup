# Полный аудит калькулятора дверей

Проведён по цепочке: точка входа → данные → расчёт цены → корзина → документы. Учтены все найденные нюансы и оставшиеся проблемы.

---

## 1. Точки входа

| Маршрут | Компонент / источник | Используемые API |
|--------|------------------------|------------------|
| **/doors** | `app/doors/page.tsx` — основной конфигуратор | complete-data, hardware (handles, limiters, architraves, kits), price/doors (POST) |
| **/kalkulyator-dverey** | `DoorCalculator` (page-builder) — упрощённый калькулятор | Зависит от конфигурации конструктора страниц |

Основной сценарий — страница **/doors**.

---

## 2. Загрузка данных (начало цепочки)

### 2.1 complete-data (модели, покрытия, фото, опции)

- **API:** `GET /api/catalog/doors/complete-data` (публичный, без авторизации).
- **Источник:** товары категории «Межкомнатные двери» + PropertyPhoto (по коду/значению, Domeo_Модель_Цвет).
- **Логика:**
  - **Группировка:** только по `Код модели Domeo (Web)`. Артикул поставщика в этой версии не используется. Товары без кода не попадают в список моделей.
  - **Обложка модели:** при наличии цветов у модели — приоритет первому фото из цветов (лист «Цвет», PropertyPhoto Domeo_Модель_Цвет); иначе — cover из PropertyPhoto (по коду), затем первое ProductImage товара модели.
  - **Цвета/покрытия:** PropertyPhoto «Domeo_Модель_Цвет» по префиксу «Название модели|» (и fallback по коду модели, если по названию пусто).
  - **Опции по модели** (реверс, зеркало, порог, наполнение, стекло): **агрегация по всем товарам** с данным Код модели Domeo (Web) — доступно то, что доступно хотя бы у одного; надбавки (реверс, зеркало, порог) = максимум по товарам; наполнение = объединение уникальных названий; стекло = объединение «Domeo_Стекло_доступность».
  - **Кромка:** из properties товаров (лист «Наценка за кромку» при импорте): `Domeo_Кромка_в_базе_включена`, `Domeo_Кромка_базовая_цвет`, Цвет 2/3/4 и наценки. В ответе: `edge_in_base`, `edge_options` (id, name, surcharge).
- **Кэш:** 30 минут в памяти; сброс — `DELETE /api/catalog/doors/complete-data` (требует авторизации).

**Проблемы:**

1. **Модели без цветов в «Цвет»**  
   У 6 моделей из «Цены базовые» нет строк в листе «Цвет» (Rimini 12/2 ПО кр., Enigma 2 ДГ, Molis 1 эмаль ДГ, Porta Invisible, Фантом Люкс). В конфигураторе для них не будет фото и вариантов цвета (см. MISSING_DATA_REPORT.md).

2. **Модели без опций**  
   2 модели нет в листе «Опции» — реверс/зеркало/порог не подтягиваются (Rimini 12/2 ПО кр.).

3. **80 моделей нет в «Наценка за кромку»**  
   Варианты кромки и наценки по ним не приходят из листа; кромка в UI может быть пустой или не соответствовать данным Excel.

4. **Связь модель ↔ цвета по названию**  
   complete-data привязывает цвета по «Название модели» (фабричное). Если в Excel «Цвет» и «Цены базовые» различаются по написанию названия модели, связь не строится. Рекомендация в DISCREPANCIES_AND_RULES — унифицировать «Название модели» или добавить слияние по «Код модели Domeo (Web)».

### 2.2 Детали модели (покрытия, кромки)

- **Источник:** тот же ответ complete-data; на фронте — хук `useModelDetails(selectedModelId)`.
- **Кромки:** приоритет — массив `edge_options` из complete-data (id, name, surcharge), заполняемый из properties товаров модели (`Domeo_Кромка_*` при импорте из листа «Наценка за кромку»). Fallback: сбор из полей «Кромка» товаров, если edge_options пустой. В UI отображаются название и наценка (+X Р); фото кромки в API не передаётся (photo_path: null), в блоках показывается нейтральный фон.

**Проблемы:**

5. **Кромки при отсутствии данных в БД**  
   Если у товаров модели не заполнены свойства из листа «Наценка за кромку» (Domeo_Кромка_*), используется fallback по полю «Кромка» товаров; при пустом и том и другом список кромок в UI будет пустым.

### 2.3 Фурнитура (ручки, наличники, ограничители, комплекты)

- **API:** `GET /api/catalog/hardware?type=handles|limiters|architraves|kits` (публичный).
- **Источник:** товары категорий «Ручки и завертки», «Ограничители», «Наличники», «Комплекты фурнитуры» + цены из properties_data / base_price.

**Проблемы:**

6. Нет критичных: verify-calculator-links и verify-ui-photos показывают наличие ручек и комплектов; фото привязаны.

### 2.4 Каскадные опции (размеры, реверс, наполнение, покрытие, цвет)

- **API:** `GET /api/catalog/doors/model-options?model=...&style=...&reversible=...&width=...&height=...&finish=...&color=...`
- Фильтр по модели — только по `Код модели Domeo (Web)` (Артикул поставщика не используется). Опции агрегируются по отфильтрованному набору товаров.
- Используется для сужения списка размеров и вариантов кромки по выбранной модели и текущим фильтрам.
- **Проблемы:** при отсутствии данных по модели опции могут быть неполными.

### 2.5 Отображение фото в калькуляторе (проверено по коду)

- **Единый слой:** `lib/configurator/image-src.ts` — `getImageSrc`, `getImageSrcWithPlaceholder`, `toDisplayUrl` (пути `/uploads/...` → `/api/uploads/...`).
- **Карточки моделей:** `model.photo` → `getImageSrcWithPlaceholder(..., placeholder SVG)`; при ошибке загрузки `onError` подставляет тот же placeholder. Источник photo — complete-data (обложка по логике п. 2.1).
- **Цвета (покрытия):** `color.photo_path` → `getImageSrc`; при отсутствии или ошибке — цветной квадрат (`color.color`). Фото цветов из PropertyPhoto «Domeo_Модель_Цвет».
- **Древесная палитра (Шпон):** `wood.photo_path` → `getImageSrcWithPlaceholder`.
- **Кромка:** у вариантов кромки `photo_path` в API не передаётся; в UI показывается нейтральный блок (серый фон, для «Без кромки» — «—»).
- **Наличники, ограничители:** `getImageSrcWithPlaceholder` с плейсхолдером при отсутствии пути.
- **Ручки:** `getHandleImageSrc` — приоритет пути из API, иначе mockup по имени из `/data/mockups/ruchki/`.
- **Итог:** все места используют единый слой; при локальных путях в БД (после replace-http-photos и verify-all-photos-display) фото отдаются через `/api/uploads/`. Риск — неверная привязка обложки модели к коду (см. COMPLETE_DATA_LOGIC_QA.md, п. 2).

### 2.6 Отображение вариантов кромки (проверено по коду)

- **Источник списка:** `useModelDetails` → из complete-data `edge_options` (id, name, surcharge); при пустом — fallback по полю «Кромка» товаров (без наценки в этом случае).
- **Формирование блоков на странице:** `edgeOptions` в `app/doors/page.tsx` — из `edges` добавляется «Без кромки» только если `!edge_in_base`; затем все варианты из `edges`, отфильтрованные по `modelOptionsData.edges` (имена цветов по отфильтрованным товарам).
- **Отображение:** для каждого варианта — название, при surcharge > 0 строка «+X Р» (руб); изображение — только если есть `edge.photo_path` (сейчас в API всегда null).
- **Выбор при «кромка в базе»:** при `edge_in_base` вариант «Без кромки» не показывается; при смене модели автоматически выбирается первый вариант кромки, если текущий не в списке.
- **Итог:** варианты кромки и наценки выводятся корректно; расчёт цены с учётом кромки — в price/doors и пересчёте корзины (п. 3, 4).

---

## 3. Расчёт цены

### 3.1 API price/doors (POST)

- **Вызов:** с страницы /doors через хук `usePriceCalculation()` → `POST /api/price/doors` с телом `{ selection }`.
- **Параметры selection:** model (modelKey), style, finish, color, width, height, reversible, mirror, threshold, edge_id (опционально — цвет кромки для надбавки), handle (id), hardware_kit (id), limiter_id, option_ids (массив id — наличники).

**Логика в API:**

1. Загрузка всех товаров категории «Межкомнатные двери».
2. Фильтр по style, model (Domeo_Название модели / Код модели Domeo (Web) / Артикул), finish (Тип покрытия), color (Domeo_Цвет), width, height.
3. При нескольких совпадениях берётся товар с **максимальной** ценой РРЦ (закомментировано как «временно»).
4. База = Цена РРЦ товара (или base_price).
5. Надбавки: реверс, зеркало (одна/две стороны), порог — из properties товара двери; комплект фурнитуры и ручка — отдельные товары по id; ограничитель и option_ids (наличники) — по id, цена из РРЦ/base_price.

**Исправлено:** Кромка участвует в расчёте. Логика: из листа «Наценка за кромку» в `properties_data` хранятся `Domeo_Кромка_в_базе_включена`, `Domeo_Кромка_базовая_цвет`, `Domeo_Кромка_Цвет_2/3/4` и `Domeo_Кромка_Наценка_Цвет_2/3/4`. При «Кромка включена в базовую цену» = Да в API complete-data возвращаются `edge_in_base` и `edge_options` (базовая = 0, остальные цвета с наценкой). В price/doors при `selection.edge_id` выбирается надбавка по совпадению с базовым цветом (0) или Цвет 2/3/4 и добавляется в breakdown и total.

8. **Выбор товара «по максимальной цене»**  
   При нескольких подходящих товарах берётся товар с максимальной Ценой РРЦ. Для одной комбинации (модель, размер, покрытие, цвет) в БД должна быть одна запись; при дублях логичнее брать первый или явно задать правило (например, приоритет по SKU).

9. **GET /api/price/doors?model=**  
   Поиск по полю `product.model`. У дверей основные данные (код модели и т.д.) лежат в `properties_data`, поле `model` может быть пустым или другим. Поиск по query-параметру `model` может не находить товар. Для основного сценария это не мешает (расчёт идёт через POST).

### 3.2 Совпадение параметров фронт ↔ API

- Фронт передаёт: `door_model_id` → selection.model (это modelKey, например DomeoDoors_Base_1), finish = coating_type, color = color_name из выбранного покрытия.
- API фильтрует по Тип покрытия и Domeo_Цвет — соответствие есть.
- Ручки/комплекты/ограничители/наличники передаются по id — корректно.

---

## 4. Корзина и документы

- Добавление в корзину: по нажатию «В корзину» вызывается расчёт цены; в корзину попадает позиция с unitPrice = priceData.total, sku_1c, параметрами (в т.ч. edgeId, option_ids для наличников).
- Пересчёт цены в корзине: `lib/cart/price-recalculation-service.ts` вызывает тот же API price/doors (POST) по данным позиции; в selection передаётся `edge_id`, надбавка за кромку включается в итог (исправлено вместе с п. 7).

---

## 5. Прочие API и скрипты

### 5.1 options и edge-cost

- **GET /api/catalog/doors/options** — захардкожен ID категории дверей (`cmlg8vri200037kf4bec1l5bx`) и статические комплекты/ручки (не из БД). Страница /doors этот endpoint не использует (берёт данные из complete-data и hardware). Риск: при смене ID категории или при использовании options в другом месте — неверные данные.
- **GET /api/catalog/doors/edge-cost** — захардкожен тот же ID категории; требует авторизации. Возвращает аналитику по полям «Кромка» и «Стоимость надбавки за кромку». На основной расчёт цены не влияет.

**Проблемы:**

11. **Жёстко заданный ID категории**  
    В options и edge-cost используется константа `cmlg8vri200037kf4bec1l5bx`. Надёжнее получать ID через getDoorsCategoryId().

### 5.2 sku-to-selection

- **GET/POST /api/catalog/doors/sku-to-selection** — по SKU возвращает selection для предзаполнения формы. Требует авторизации. Маппинг: style ← product.series, model ← product.model, finish/color ← properties. У дверей стиль/модель/покрытие хранятся в properties_data под другими ключами (Domeo_Стиль Web, Код модели Domeo (Web), Тип покрытия и т.д.), поэтому предзаполнение по SKU может быть неточным.

**Проблемы:**

12. **Предзаполнение по SKU**  
    Для дверей лучше строить selection из properties_data (Domeo_Стиль Web, Код модели Domeo (Web), Тип покрытия, Domeo_Цвет, Ширина/мм, Высота/мм и т.д.), а не из product.model/series и общих properties.

---

## 6. Сводка оставшихся проблем

| № | Суть | Где | Критичность |
|---|------|-----|-------------|
| 1 | Модели без цветов/фото (6 моделей нет в листе «Цвет») | Excel / импорт | Средняя: для этих моделей конфигуратор без цветов |
| 2 | Модели без опций (2 модели нет в «Опции») | Excel / импорт | Низкая |
| 3 | 80 моделей нет в «Наценка за кромку» | Excel / импорт | Средняя: кромка в UI/цене может быть неполной |
| 4 | Связь модель ↔ цвета по названию; расхождения написания | Excel, complete-data | **Смягчено:** в импорте «Цвет» добавлено слияние по коду (дублирование привязки по «Код модели Domeo (Web)») |
| 5 | Кромки при пустых Domeo_Кромка_* в БД — fallback по «Кромка»; при обоих пусто список пустой | complete-data, useModelDetails | Низкая |
| 6 | — | Фурнитура | Нет |
| ~~7~~ | ~~Кромка не в цене~~ | — | **Исправлено** |
| 8 | Выбор товара «по максимальной цене» при нескольких совпадениях | app/api/price/doors/route.ts | Низкая (оставлено по решению) |
| ~~9~~ | ~~GET /api/price/doors?model= может не находить товар~~ | app/api/price/doors/route.ts | **Исправлено:** при отсутствии по product.model поиск по категории дверей и properties_data (Код модели Domeo (Web), Domeo_Название модели для Web) |
| ~~10~~ | ~~Пересчёт корзины без кромки~~ | — | **Исправлено** (следствие 7) |
| ~~11~~ | ~~Захардкожен ID категории~~ | options, edge-cost, models, photos*, complete-data-simple, photos-batch, admin import-doors | **Исправлено:** везде используется getDoorsCategoryId() |
| ~~12~~ | ~~Предзаполнение по SKU для дверей неточное~~ | sku-to-selection/route.ts | **Исправлено:** для категории «Межкомнатные двери» selection строится из properties_data (Код модели Domeo (Web), Тип покрытия, Domeo_Цвет и т.д.) |

---

## 7. Рекомендуемый порядок исправлений

1. ~~**Учёт кромки (7, 10)**~~ — сделано: complete-data отдаёт edge_options с surcharge, price/doors добавляет надбавку по edge_id.
2. ~~**ID категории (11)**~~ — сделано: getDoorsCategoryId() используется во всех API дверей и в admin import-doors при отсутствии categoryId.
3. ~~**Предзаполнение по SKU (12)**~~ — сделано: для товаров категории «Межкомнатные двери» selection строится из properties_data (Domeo_Стиль Web, Код модели Domeo (Web), Тип покрытия, Domeo_Цвет, Ширина/мм, Высота/мм, при наличии — edge_id).
4. **Данные Excel (1–4):** слияние по коду в импорте «Цвет» добавлено; при расхождениях названий модели в листах цвета подтягиваются по коду после повторного импорта.

---

---

## 8. Проверка (последнее обновление)

- **Отображение фото:** проверено по коду (карточки моделей, цвета, кромка, наличники, ограничители, ручки) — единый слой image-src, плейсхолдеры и fallback на месте. Рекомендуется визуальная проверка на /doors после сброса кэша complete-data.
- **Варианты кромки:** источник edge_options из complete-data, отображение названия и «+X Р», авто-выбор при edge_in_base — реализовано.
- **Перезапуск сервера:** при необходимости перезапуска dev-сервера учесть, что порт 3000 может быть занят (остановить процесс на 3000 или использовать другой порт).

*Аудит выполнен по кодовой базе и скриптам проверки (verify-calculator-links, verify-all-photos-display, verify-photo-download-and-binding, diagnose-door-photos, verify-excel-db-and-links).*

---

## 9. Пояснение: предзаполнение по SKU (п. 12)

**Что это:** API `GET/POST /api/catalog/doors/sku-to-selection?sku=...` по артикулу товара (SKU) возвращает объект `selection` для подстановки в форму конфигуратора на странице /doors. Используется, когда у вас есть только артикул (например, из 1С, из письма или из ссылки «дверь по SKU») и нужно открыть конфигуратор с уже выбранной моделью, размером, цветом и т.д.

**Реализовано:** для товаров категории «Межкомнатные двери» selection строится из `properties_data`: стиль (Domeo_Стиль Web), модель (Код модели Domeo (Web)), тип покрытия, цвет (Domeo_Цвет), ширина/высота (Ширина/мм, Высота/мм), при наличии — базовая кромка (edge_id). Для остальных категорий используется прежняя логика по полям product.model/series и properties.
