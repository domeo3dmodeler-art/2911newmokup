# SSH: «Connection closed by remote host» и нестабильное соединение с ВМ

## Два типа проблем

| Ситуация | Раздел ниже |
|----------|-------------|
| Сессия обрывается **сразу после входа** (виден motd, потом отключение) | [Симптом 1](#симптом-1-обрыв-сразу-после-входа) |
| Соединение **обрывается во время загрузки** (scp/rsync) или через несколько секунд | [Нестабильное соединение](#нестабильное-соединение-обрыв-во-время-передачи) |

---

## Симптом 1: обрыв сразу после входа

- Подключение по ключу успешно: виден приветственный баннер Ubuntu (motd).
- Сразу после этого сессия обрывается: `Connection to 158.160.72.3 closed by remote host`.
- Раньше интерактивный вход работал.

## Возможные причины (по приоритету)

### 1. Выход из шелла в `~/.bashrc` или `~/.profile`

При интерактивном входе выполняется `~/.profile` и `~/.bashrc`. Если в конце есть `exit` или команда с `set -e`, которая падает, шелл завершается и SSH закрывает соединение.

Типичные «виновники»:
- В конце `.bashrc`: `exit`, `exec something` (и something завершается).
- Условие вроде: `tty -s && exit 0` или аналог.
- Вызов скрипта/команды, которая возвращает ненулевой код при `set -e`.

### 2. Ограничение в `~/.ssh/authorized_keys`

В `authorized_keys` у пользователя `petr` может быть строка с префиксом:
- `command="..."` — выполняется только эта команда; после её завершения сессия закрывается.
- `restrict` и т.п. — сами по себе не закрывают сессию, но могут сочетаться с `command=`.

Если ключ добавляли через скрипт без `command=`, такая строка могла попасть из другого места (например, копирование из инструкции с ограничением).

### 3. Настройки SSH-сервера (`sshd_config`)

- `ForceCommand` для пользователя или группы — выполняется одна команда, затем соединение закрывается.
- Проверяется в `/etc/ssh/sshd_config` и в `Include`-файлах (например, `/etc/ssh/sshd_config.d/*.conf`).

### 4. Оболочка пользователя

- В `/etc/passwd` у пользователя `petr` может быть указана оболочка вроде `/usr/sbin/nologin` или скрипт, который сразу выходит.
- После обновления системы или правок пользователя такое могли изменить.

### 5. Ресурсы и PAM

- Переполнен диск или исчерпана квота пользователя — шелл может не запуститься.
- Редко: модуль PAM при входе завершает сессию (логи в `/var/log/auth.log`).

---

## Как попасть на ВМ без интерактивного SSH

### Вариант A: Консоль в Yandex Cloud

1. Откройте [консоль Yandex Cloud](https://console.yandex.cloud/) → Compute Cloud → Виртуальные машины.
2. Выберите ВМ с IP `158.160.72.3`.
3. Нажмите **«Подключиться»** (или аналог) и выберите способ: **Serial console** / **Консоль** / **VNC** (как называется в интерфейсе).
4. Войдите под пользователем `petr` (логин и пароль, если задан) или под `root`, если есть доступ.
5. Дальше выполняйте команды из раздела «Что проверить на ВМ».

### Вариант B: Неинтерактивная команда по SSH (`-T`)

Иногда при проблемах в `.bashrc` неинтерактивный запуск команды даёт сессию без выполнения `.bashrc` (зависит от того, как именно настроен bash). С вашей машины:

```powershell
ssh -i "C:\02_conf\ssh1702\ssh-key-1771306236042\ssh-key-1771306236042" -T petr@158.160.72.3 "bash --norc --noprofile -c 'echo OK && cat ~/.bashrc | tail -20'"
```

- Если в выводе будет `OK` и содержимое конца `~/.bashrc` — подключение по ключу и bash работают, проблема скорее в интерактивном `.bashrc`/`.profile`.
- Если и эта команда обрывается — смотрите вариант A (консоль) и логи ниже.

---

## Что проверить на ВМ (через консоль или удалённо)

Зайдите на ВМ (консоль Yandex или, если сработает, `ssh -T ... "bash --norc --noprofile -c '...'"` и замените `...` на одну из команд ниже по очереди).

### 1. Конец `~/.bashrc` и `~/.profile`

```bash
tail -30 /home/petr/.bashrc
tail -30 /home/petr/.profile
```

Ищите в конце: `exit`, `exec`, вызовы команд, которые могут падать при интерактивном запуске.

### 2. Содержимое `authorized_keys`

```bash
cat /home/petr/.ssh/authorized_keys
```

Проверьте, нет ли перед ключом префиксов `command="..."`, `no-pty` и т.д. Для обычного интерактивного входа должна быть одна строка: тип ключа + ключ + возможно комментарий, без `command=`.

### 3. Оболочка пользователя `petr`

```bash
grep "^petr:" /etc/passwd
```

Ожидается что-то вроде: `petr:x:1000:1000:...:/home/petr:/bin/bash`. Не должно быть `/usr/sbin/nologin` или пустого поля оболочки.

### 4. ForceCommand в sshd

```bash
sudo grep -r ForceCommand /etc/ssh/
sudo grep -r "Match User" /etc/ssh/
```

Если есть `ForceCommand` для `petr` или группы — его нужно убрать или изменить под ваши цели.

### 5. Логи при входе по SSH

На ВМ выполните (или посмотрите после следующей попытки входа с вашего ПК):

```bash
sudo tail -50 /var/log/auth.log
```

Ищите строки с `sshd` и вашим IP: принятие ключа, запуск сессии, возможные ошибки или сообщение о закрытии.

### 6. Место на диске

```bash
df -h /
quota -u petr 2>/dev/null || true
```

---

## Типичное исправление, если виноват `.bashrc`

Если в конце `~/.bashrc` есть `exit` или подозрительная команда:

```bash
# Резервная копия
cp /home/petr/.bashrc /home/petr/.bashrc.bak

# Редактирование (nano/vi)
nano /home/petr/.bashrc
```

Удалите или закомментируйте строку с `exit` / проблемной командой. Сохраните и выйдите. После этого снова попробуйте интерактивный SSH с вашего ПК.

---

## Если виноват `command=` в authorized_keys

Привести строку к «нормальному» ключу без ограничений:

```bash
nano /home/petr/.ssh/authorized_keys
```

Удалите префикс до начала типа ключа (например, `ssh-rsa` или `ssh-ed25519`). Должна остаться одна строка вида:
`ssh-rsa AAAA... comment`. Сохраните, проверьте права: `chmod 600 /home/petr/.ssh/authorized_keys`.

---

## Проверка после правок

С вашего ПК:

```powershell
ssh -i "C:\02_conf\ssh1702\ssh-key-1771306236042\ssh-key-1771306236042" petr@158.160.72.3
```

Должен открыться интерактивный шелл без немедленного обрыва.

---

## Краткий чеклист

| Проверка | Где | Что искать |
|----------|-----|------------|
| Выход в шелле | `~/.bashrc`, `~/.profile` | `exit`, падающие команды в конце |
| Ограничение ключа | `~/.ssh/authorized_keys` | `command="..."` перед ключом |
| Оболочка | `/etc/passwd` | `/bin/bash` у пользователя `petr` |
| SSH-сервер | `/etc/ssh/sshd_config*` | `ForceCommand`, `Match User petr` |
| Ресурсы | `df -h`, `quota` | Место на диске, квоты |
| Логи | `/var/log/auth.log` | События sshd при вашем входе |

После того как найдёте причину (чаще всего это `.bashrc` или `command=` в `authorized_keys`), исправьте её через консоль Yandex и снова проверьте интерактивный вход по SSH.

---

## Нестабильное соединение (обрыв во время передачи)

### Симптомы

- `scp` или `rsync` обрываются с «Connection closed by remote host» через 5–30 секунд.
- Иногда первый файл загружается, следующие — нет.
- Интерактивный вход может работать, но сессия рвётся при долгой работе.

### Что сделать по шагам

#### 1. Убедиться, что интерактивный SSH держится

С вашего ПК откройте сессию и не трогайте её 1–2 минуты:

```powershell
ssh -i "C:\02_conf\ssh1702\ssh-key-1771306236042\ssh-key-1771306236042" -o ServerAliveInterval=15 -o ServerAliveCountMax=6 petr@158.160.72.3
```

- Если сессия **сразу** закрывается — сначала устраните причину из раздела [Симптом 1](#симптом-1-обрыв-сразу-после-входа) (через консоль Yandex).
- Если сессия **держится**, но scp рвётся — переходите к п. 2–4.

#### 2. На ВМ: увеличить таймауты SSH-сервера

Зайти на ВМ через **консоль Yandex Cloud** (Serial console) или по SSH, если он уже держится. Затем:

```bash
sudo nano /etc/ssh/sshd_config
```

Добавьте или измените (без дублирования):

```
ClientAliveInterval 30
ClientAliveCountMax 6
TCPKeepAlive yes
```

Перезапуск sshd:

```bash
sudo systemctl restart sshd
```

После этого снова попробуйте `scp` или скрипт деплоя.

#### 3. На ВМ: проверить лимиты sshd

```bash
sudo grep -E "MaxStartups|MaxSessions" /etc/ssh/sshd_config
```

Если `MaxStartups` слишком маленький (например 3), можно увеличить:

```
MaxStartups 20:30:60
MaxSessions 20
```

И снова `sudo systemctl restart sshd`.

#### 4. На вашем ПК: всегда использовать keepalive

В скриптах уже используются опции `ServerAliveInterval=15` и `ServerAliveCountMax=6`. Для ручных команд добавляйте их явно:

```powershell
ssh -i "C:\02_conf\ssh1702\ssh-key-1771306236042\ssh-key-1771306236042" -o ServerAliveInterval=15 -o ServerAliveCountMax=6 petr@158.160.72.3
scp -i "C:\02_conf\ssh1702\ssh-key-1771306236042\ssh-key-1771306236042" -o ServerAliveInterval=15 -o ServerAliveCountMax=6 .\file.txt petr@158.160.72.3:~/1002doors/
```

#### 5. Если ничего не помогло: деплой через Git

Код на ВМ можно обновлять без долгого scp:

1. Локально: закоммитить и запушить изменения.
2. На ВМ (по SSH или через консоль Yandex):

   ```bash
   cd ~/1002doors && git pull && npm run build && sudo systemctl restart domeo-staging
   ```

Так вы не зависите от стабильности длительного scp-соединения.
