# Логика complete-data и расчёта: вопросы и зафиксированные правила

Документ для согласования и фиксации правил. После ответов — перенести итог в CALCULATOR_AUDIT или отдельный раздел.

---

## 1. Группировка моделей

**Зафиксировано:** В этой версии используется только **«Код модели Domeo (Web)»**. Артикул поставщика для группировки не используется.

- Товар попадает в модель только если заполнен `Код модели Domeo (Web)`.
- Товары без кода (или с пустым кодом) не участвуют в группировке и не показываются в списке моделей.

**Вопрос:** Товары, у которых в БД есть только «Артикул поставщика», но нет «Код модели Domeo (Web)» — их нужно полностью исключить из конфигуратора или для них предусмотреть запасной вариант (например, подставлять артикул только для отображения, но не для группировки)?

---

## 2. Фото обложки модели

**Проблема:** Сейчас обложки моделей берутся из PropertyPhoto с `propertyName = "Артикул поставщика"` и `propertyValue = modelKey` (в нижнем регистре). Скрипт `bind-model-covers-from-color-photos.ts` привязал обложки **по индексу** (i-й префикс из «Цвет» → i-й код модели в отсортированном списке), а не по смысловой связи «модель ↔ фабричное название». Из‑за этого обложка может показываться не для той модели.

**Вопросы:**

1. **Источник обложки:** Откуда должна браться обложка модели в приоритете?
   - a) Одна явная обложка на «Код модели Domeo (Web)» (отдельная таблица/PropertyPhoto с ключом по коду)?
   - b) Первое фото из цветов (лист «Цвет») по любому из фабричных названий этой модели?
   - c) Другое (опишите).

2. **PropertyPhoto:** Нужно ли завести отдельное свойство для обложки по коду модели (например, `propertyName = "Код модели Domeo (Web)"` и `propertyValue = код`), или продолжаем использовать «Артикул поставщика», но гарантировать, что в `propertyValue` всегда записан именно код Domeo (Web)?

3. **Скрипт привязки:** Переписать ли `bind-model-covers-from-color-photos.ts` так, чтобы сопоставление было по смыслу (например, по совпадению «Название модели» из «Цвет» с «Domeo_Название модели для Web» в товарах), а не по индексу в отсортированных списках?

---

## 3. Опции по модели (реверс, зеркало, порог, наполнение, стекло)

**Зафиксировано:** Все опции, которые доступны **хотя бы у одного** товара с данным «Код модели Domeo (Web)», участвуют в фильтрации и считаются доступными для модели.

**Реализация:**

- По **всем** товарам модели (все products с этим modelKey) собираем:
  - реверс: доступен, если **у хотя бы одного** товара «Реверс доступен» = Да;
  - зеркало: доступно, если **у хотя бы одного** «Зеркало доступно» = Да;
  - порог: доступен, если **у хотя бы одного** «Порог доступен» = Да;
  - наполнение: объединение уникальных значений «Название наполнения» по всем товарам;
  - стекло: объединение уникальных значений «Domeo_Стекло_доступность» по всем товарам (все варианты цветов стекла по модели).
- Надбавки (руб за реверс, зеркало одну/две стороны, порог): при разных значениях у разных товаров — брать **максимум** по модели (чтобы ни один вариант не был недооценён), либо первый ненулевой — нужно уточнить.

**Вопрос:** Надбавки за реверс/зеркало/порог у товаров с одним «Код модели Domeo (Web)» в ваших данных всегда совпадают или бывают разные? Если разные — правило: брать максимум, первый ненулевой или всегда из одного «главного» товара (например, первого по SKU)?

---

## 4. Кромка по модели

Сейчас опции кромки (базовый цвет, Цвет 2/3/4 и наценки) берутся из **первого** товара модели. В импорте строка листа «Наценка за кромку» привязана к «Название модели» и подставляется во все товары этой модели, так что значения должны совпадать.

**Вопрос:** Подтверждаете, что для всех товаров с одним «Код модели Domeo (Web)» данные кромки (в базе/в Excel) одинаковые, и достаточно брать их из одного любого товара (например, первого)?

---

## 5. Цвета и покрытия (лист «Цвет»)

Цвета и фото по типам покрытия привязаны к **фабричному названию** модели (первая часть `propertyValue` в Domeo_Модель_Цвет: «Название модели» из листа «Цвет»). У одной модели Domeo (один код) может быть несколько фабричных названий; цвета собираются по всем этим названиям (объединение).

**Зафиксировано:** Для одной модели (один Код модели Domeo (Web)) показываем объединённый набор цветов/покрытий по всем её фабричным названиям.

**Вопрос:** Нужно ли в UI как-то разделять цвета по фабричным названиям (например, группами), или достаточно одного общего списка цветов/покрытий по модели?

---

После ответов на вопросы логику можно окончательно зафиксировать в коде и в CALCULATOR_AUDIT.
