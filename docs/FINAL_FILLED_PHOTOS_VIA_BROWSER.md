# Скачивание фото из Excel (Яндекс.Диск 360) через браузер и привязка к БД

В файле `1002/final_filled 30.01.xlsx` на листах **Наличники**, **Цвет**, **04 Ручки Завертки**, **05 Ограничители** в столбцах с фото стоят ссылки на страницы просмотра `disk.360.yandex.ru` (не прямые файлы). Токена Яндекс.Диска нет — качать нужно через браузер (ваша сессия).

## Вариант 1: Всё в одном запуске (рекомендуется)

Один раз войти в Яндекс в окне браузера, затем скрипт сам обойдёт все ссылки и скачает картинки:

```bash
npx tsx scripts/download-and-bind-photos-from-final-filled.ts --wait-login
```

- Откроется окно браузера (puppeteer-extra со stealth-плагином, чтобы реже срабатывала защита «Я не робот»).
- Откроется первая ссылка на Диск. Если появится проверка **«Я не робот»** — пройдите её вручную в этом окне. При необходимости войдите в аккаунт Яндекс.
- Скрипт ждёт 60 секунд, затем проходит по всем уникальным URL. На каждой странице приоритетно ищет ссылку на скачивание изображения, иначе — самый большой `img` (чтобы не сохранять чёрный фон/плейсхолдер). Скачивает в `public/uploads/final-filled/` (подпапки: Наличники, Цвет, 04 Ручки Завертки, 05 Ограничители) и обновляет БД: **ProductImage** (наличники, ручки, ограничители) и **PropertyPhoto** (лист «Цвет», свойство Domeo_Модель_Цвет).

## Вариант 2: Цепочка через JSON (сбор ссылок → скрипт с браузером → привязка)

Удобно, если нужно сначала только собрать ссылки из Excel, а скачивание запустить позже или с другими опциями.

1. **Собрать ссылки из Excel в JSON**
   ```bash
   npm run collect:photo-entries
   ```
   Создаётся `scripts/photo-entries.json` (записи + уникальные URL + `urlToRelPath`).

2. **Скачать фото через браузер и привязать к БД**
   ```bash
   npx tsx scripts/download-and-bind-photos-from-final-filled.ts --entries-json=scripts/photo-entries.json --wait-login
   ```
   Поведение как в варианте 1, но список записей берётся из JSON, а не из Excel.

3. **Только привязка** (если скачивание уже сделано и есть `scripts/resolved-urls.json`):
   ```bash
   npm run bind:final-filled-from-json
   ```
   Читает `scripts/photo-entries.json` и `scripts/resolved-urls.json` (страница → локальный путь) и обновляет ProductImage / PropertyPhoto.

## Вход в аккаунт через MCP-браузер

Если нужно сначала войти в Яндекс в браузере Cursor (MCP):

1. Попросите агента открыть первую ссылку из `photo-entries.json` в MCP-браузере.
2. Войдите в аккаунт на открытой странице.
3. Для массового скачивания всё равно используйте вариант 1 выше (Puppeteer откроет свой браузер; сессия MCP и сессия Puppeteer разные, войти придётся один раз в окне Puppeteer).

## Скрипты

| Скрипт | Назначение |
|--------|------------|
| `scripts/collect-photo-entries.ts` | Читает Excel, пишет `photo-entries.json`. |
| `scripts/download-and-bind-photos-from-final-filled.ts` | Скачивание через браузер (Puppeteer) и привязка к БД. Поддерживает `--entries-json=...` и `--wait-login`. |
| `scripts/download-one-image.ts` | Скачивает одно изображение по URL в файл (для ручного/точечного использования). |
| `scripts/bind-photos-from-json.ts` | Привязка по `photo-entries.json` + `resolved-urls.json`. |

## Опции download-and-bind-photos-from-final-filled.ts

- `--dry-run` — только показать ссылки и привязки.
- `--skip-download` — не качать, только привязать уже сохранённые файлы (по путям в БД).
- `--out-dir=DIR` — каталог сохранения (по умолчанию `public/uploads/final-filled`).
- `--file=PATH` — путь к xlsx.
- `--entries-json=PATH` — брать записи из JSON (например `scripts/photo-entries.json`).
- `--wait-login` — пауза 60 сек после открытия первой ссылки (успеете войти в Яндекс).
- `--headless` — браузер без окна (по умолчанию с окном).
