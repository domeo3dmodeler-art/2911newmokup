# Импорт данных из final_filled 30.01.xlsx в БД

Все данные для конфигуратора дверей (модели, цены, покрытия, цвета, фото, наличники, фурнитура, ручки, ограничители) переносятся из файла **final_filled 30.01.xlsx** в базу данных.

## Где лежит файл

- Исходный файл: **`1002/final_filled 30.01.xlsx`**
- Если папки `1002` нет — создайте её в корне проекта.
- Положите в неё файл `final_filled 30.01.xlsx`.

## Порядок действий

### 1. Создать дерево каталога (один раз)

Создаёт корень «Каталог» и категории: Межкомнатные двери, Наличники, Комплекты фурнитуры, Ручки и завертки, Ограничители.

```bash
npx tsx scripts/seed-catalog-tree.ts
```

Результат: в `scripts/catalog-tree-ids.json` появятся ID категорий.

### 2. Импорт данных из Excel в БД

```bash
npx tsx scripts/import-final-filled.ts
```

Импортируются:

- **Наличники** — лист «Наличники»
- **Фурнитура** — лист «Фурнитура»
- **Ручки и завертки** — лист «04 Ручки Завертки»
- **Ограничители** — лист «05 Ограничители»
- **Двери** — листы «Цены базовые», «Опции», «Стекло_доступность», «Наценка за кромку» (товары по размерам и ценам)
- **Цвет/фото покрытий** — лист «Цвет» → таблица `property_photos` (для конфигуратора: фото и варианты цветов по моделям)

**Важно:** В листах «Цены базовые» и «Цвет» поле **«Название модели»** должно совпадать на 100% (одинаковый текст в обеих вкладках). От этого зависит связь модели со стилями и цветами в конфигураторе. При импорте выводятся предупреждения, если названия не совпадают.

### Опции импорта

- **Только просмотр (ничего не записывать):**
  ```bash
  npx tsx scripts/import-final-filled.ts --dry-run
  ```
- **Без дверей** (только наличники, фурнитура, ручки, ограничители):
  ```bash
  npx tsx scripts/import-final-filled.ts --no-doors
  ```

## Проверка после импорта

1. **Загрузка данных в БД** — скрипт сверяет ожидаемые количества (по файлу) с записями в БД:
   ```bash
   npx tsx scripts/verify-data-loaded.ts
   ```
   Должно быть: «Итог: все данные из файла загружены в БД.»

2. **Связи для калькулятора** — проверка связей модель↔цвета (PropertyPhoto), расчёт цены по выборке, наличие ручек и комплектов:
   ```bash
   npx tsx scripts/verify-calculator-links.ts
   ```

3. **Проверка на UI** (вручную после `npm run dev`):
   - Открыть страницу конфигуратора: **`/doors`** или **`/newmocap`**.
   - Убедиться, что отображаются стили и модели, у выбранной модели — фото и типы покрытия/цвета.
   - Выбрать модель, покрытие, цвет, размер; проверить, что отображается цена и кнопки «В корзину» / «Заказать в 1 клик» работают.

## После импорта

- Конфигуратор дверей (`/doors`, `/newmocap`) берёт модели и цены из **Product**, фото и цвета покрытий из **PropertyPhoto**.
- API: `/api/catalog/doors/complete-data`, `/api/price/doors`, `/api/catalog/hardware?type=handles|kits`.
- ID категорий в API определяются по **имени** категории (см. `lib/catalog-categories.ts`), поэтому после пересоздания БД достаточно заново выполнить шаги 1 и 2.

## Устранение проблем

| Проблема | Решение |
|----------|--------|
| «Файл не найден» | Проверьте путь `1002/final_filled 30.01.xlsx` и имя файла (с пробелами). |
| «Не найдены ID категорий» | Сначала выполните `npx tsx scripts/seed-catalog-tree.ts`. |
| Нет моделей/цен в конфигураторе | Убедитесь, что импорт прошёл без ошибок и категория «Межкомнатные двери» есть в БД. |
| Нет фото/цветов покрытий | Импорт листа «Цвет» должен создавать записи в `property_photos`. Проверьте, что лист «Цвет» есть в файле и заполнен. |
