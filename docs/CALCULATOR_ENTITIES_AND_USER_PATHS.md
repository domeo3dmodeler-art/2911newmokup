# Калькулятор дверей: связи сущностей, путь пользователя и оценка логики

Документ даёт **полное понимание**: откуда берётся каждая сущность, как они связаны между собой, в каком порядке пользователь делает выбор и как оценить логику.

---

## 1. Словарь сущностей и источник данных

Единая цепочка: **Excel (лист) → импорт → БД (таблица/поле) → API → UI (state/отображение) → расчёт цены / корзина**.

| Сущность | Лист Excel | В БД | API для UI | В расчёт цены | В корзине (отдельная строка?) |
|----------|------------|------|------------|----------------|-------------------------------|
| **Стиль** | Цены базовые, столбец «Стиль Domeo (Web)» | Product.properties_data['Domeo_Стиль Web'] | complete-data (уникальные по моделям) | selection.style (фильтр товара) | Нет (часть описания двери) |
| **Модель** | Цены базовые, «Название модели», «Код модели Domeo (Web)» | Product (группа по modelKey), properties_data | complete-data: modelKey, model, style, photo, products | selection.model (обязательно) | Да (название позиции) |
| **Ширина / высота** | Цены базовые, «Ширины, мм», «Высота, мм» | Product.properties_data['Ширина/мм'], ['Высота/мм']; разворот в отдельные товары | complete-data → products → sizes | selection.width, height | Да |
| **Тип покрытия (finish)** | Цены базовые + Цвет (тип покрытия) | properties_data['Тип покрытия']; PropertyPhoto (ключ модель\|тип\|цвет) | complete-data → coatings, colorsByFinish | selection.finish | Нет (часть цвета) |
| **Цвет** | Цвет, «Цвет/отделка» | PropertyPhoto (Domeo_Модель_Цвет), propertyValue = модель\|тип\|цвет | complete-data → colorsByFinish, coatings | selection.color (название цвета) | Нет (текст в спецификации) |
| **Кромка** | Наценка за кромку + Цены базовые «Кромка в базе» | Product.properties_data['Кромка'], Domeo_Кромка_* | complete-data → edges по products модели | selection.edge_id | Нет (учтено в цене двери) |
| **Комплект фурнитуры** | Фурнитура | Product (категория «Комплекты фурнитуры») | hardware?type=kits | selection.hardware_kit.id | Да (отдельная строка в breakdown) |
| **Ручка** | 04 Ручки Завертки | Product + ProductImage (категория «Ручки и завертки») | hardware?type=handles | selection.handle.id | Да (в breakdown) |
| **Завертка (Да/Нет)** | — | Не хранится | — | Не передаётся | Нет |
| **Наличник** | Наличники | Product + ProductImage (категория «Наличники») | hardware?type=architraves | selection.option_ids[] (id наличника) | Да (отдельная строка в breakdown) |
| **Ограничитель** | 05 Ограничители | Product + ProductImage (категория «Ограничители») | hardware?type=limiters | selection.limiter_id | Да (отдельная строка в корзине) |
| **Реверс** | Опции, «Реверс доступен», «Надбавка за реверс (руб)» | Product.properties_data['Domeo_Опции_*'] по модели | complete-data → doorOptions → не отдельный список, UI: кнопки Нет/Да | selection.reversible | Нет (учтено в цене, не отдельная строка) |
| **Название наполнения** | Опции, «Название наполнения» | Product.properties_data['Domeo_Опции_Название_наполнения'] | complete-data → doorOptions.filling_name | Не передаётся (только фильтр) | Нет |
| **Зеркало** | Опции, «Зеркало доступно», «Одна/Две стороны (руб)» | properties_data по модели (Domeo_Опции_Зеркало_*) | complete-data → doorOptions → useModelDetails → options (зеркало) | selection.mirror ('one'/'both') | Нет (учтено в цене, не отдельная строка) |
| **Порог** | Опции, «Порог доступен», «Цена порога (руб)» | properties_data по модели | complete-data → doorOptions → options (порог) | selection.threshold | Нет (учтено в цене) |

**Ключ связи между листами Excel:** поле **«Название модели»**. В «Цены базовые» по нему (вместе с размерами) создаются товары дверей; из «Цвет», «Опции», «Наценка за кромку», «Стекло_доступность» данные подтягиваются в товар только при **точном совпадении** «Название модели». Если в одном листе название другое (например, другой поставщик) — связь не сработает. Подробный список недостающих связей: **docs/MISSING_DATA_REPORT.md** (генерируется скриптом `verify-excel-db-and-links.ts`).

---

## 2. Связи между сущностями (зависимости в калькуляторе)

```
Стиль
  └── фильтрует список Моделей (только модели этого стиля)

Модель (выбранная)
  └── определяет:
      ├── Размеры (widthOptions, heightOptions) — из products модели
      ├── Типы покрытия (finishes) — из coatings/colorsByFinish
      ├── Опции по модели (doorOptions): реверс, зеркало, порог, наполнение — из первого product.properties_data
      └── Кромки (edges) — из products модели

Тип покрытия (finish)
  └── определяет список Цветов (colorsByFinish[finish])

Цвет
  └── вместе с моделью, finish, width, height однозначно определяет товар двери для цены

Ручка, Комплект фурнитуры, Наличник, Ограничитель
  └── независимые справочники; выбор добавляется к цене (наличник/ограничитель — отдельные строки в breakdown/корзине)

Реверс, Зеркало, Порог
  └── зависят от модели: доступность и цены берутся из doorOptions (лист «Опции» по «Название модели»); в корзине отдельной строкой не идут
```

**Критичная связь для цены:** товар двери в БД ищется по **style + model + finish + color + width + height**. Цвет должен совпадать с полем в properties или с propertyValue в PropertyPhoto (модель|тип|цвет), иначе подбор может быть неточным.

---

## 3. Путь пользователя (пошагово)

### Шаг 1. Стиль
- Пользователь видит кнопки стилей (из всех моделей).
- Выбор стиля → фильтр моделей: показываются только модели с этим стилем.
- **Данные:** complete-data → уникальные `style` по моделям.

### Шаг 2. Модель (полотно)
- В сетке отображаются отфильтрованные модели (при необходимости ещё по фильтру «Наполнение»).
- Выбор модели → сохраняется `selectedModelId` (= modelKey). Загружаются детали модели: покрытия, цвета по типам, кромки, **опции по модели** (реверс, зеркало, порог — доступность и цены).
- **Данные:** complete-data по выбранной модели + doorOptions.

### Шаг 3. Размеры, реверс, наполнение (вкладка «ПОЛОТНО»)
- **Ширина / высота:** кнопки из размеров выбранной модели (или дефолт). Выбор участвует в подборе товара двери и в цене.
- **Реверс:** Нет/Да. Если «Да» — в расчёт добавляется надбавка из опций модели (если модель есть в листе «Опции»).
- **Наполнение:** фильтр по «Название наполнения» (из опций модели). Сокращает список моделей в сетке; на цену не влияет.
- **Звукоизоляция (Стандартное/Хорошее/Отличное):** информационные кнопки, захардкожены; на цену не влияют.

### Шаг 4. Покрытие и цвет (вкладка «ПОКРЫТИЕ И ЦВЕТ»)
- **Тип покрытия:** кнопки по типам из выбранной модели (ПЭТ, ПВХ, Шпон, Эмаль и т.д.).
- **Цвет:** после выбора типа — сетка цветов по этому типу (монохром/древесная палитра). Выбор цвета обязателен для расчёта цены.
- **Кромка:** кнопки «Без кромки» + варианты из модели. Участвует в цене (наценка за кромку в товаре).

### Шаг 5. Фурнитура
- **Комплект фурнитуры:** сетка из API hardware?type=kits. Выбор добавляется к цене и в breakdown.
- **Ручка:** модальное окно выбора из hardware?type=handles. Добавляется к цене.
- **Завертка:** Нет/Да. Только UI, в расчёт и корзину не передаётся.

### Шаг 6. Наличники
- Сетка из hardware?type=architraves. Выбор — отдельный товар в breakdown/корзине (option_ids).

### Шаг 7. Доп. опции
- **Ограничитель:** «Без ограничителя» + список из hardware?type=limiters. Выбор — отдельная строка в корзине.
- **Зеркало:** Без зеркала / Одна сторона / Две стороны. Список и цены из опций выбранной модели (doorOptions). В корзине отдельной строкой не отображается, цена входит в итог.
- **Порог:** Нет/Да. Цена из опций модели. В корзине отдельной строкой не отображается.

### Шаг 8. Цена и корзина
- **Условие расчёта:** выбраны стиль, модель, ширина, высота, тип покрытия, цвет. Остальное опционально, но добавляется к сумме при выборе.
- В корзину попадает одна позиция «дверь» с итоговой ценой (включая реверс, зеркало, порог, кромку) + при необходимости отдельные строки: ручка, комплект, наличник, ограничитель — в соответствии с breakdown API.

---

## 4. Поток данных (кратко)

1. **Загрузка страницы:**  
   complete-data (модели, стили, покрытия, цвета, кромки, doorOptions) + hardware (handles, limiters, architraves, kits).

2. **Выбор модели:**  
   Из уже загруженного complete-data берётся одна модель → её coatings, colorsByFinish, edges, doorOptions (опции зеркало/порог/реверс/наполнение).

3. **Расчёт цены:**  
   POST /api/price/doors с selection: model, style, finish, color, width, height, edge_id, handle, hardware_kit, limiter_id, option_ids (наличники), reversible, mirror, threshold.  
   Бэкенд: поиск товара двери по style/model/finish/color/width/height; добавление к сумме цены ручки, комплекта, ограничителя, опций по id; добавление надбавок за реверс, зеркало, порог из properties_data товара двери.

4. **Корзина:**  
   Сохраняются все выбранные параметры; option_ids содержат только наличники (зеркало/порог — не отдельные строки). При генерации КП/счёта/заказа те же поля передаются на бэкенд.

---

## 5. Оценка логики и риски

### Что работает согласованно
- Стиль → модель → покрытие → цвет: цепочка от БД до UI и до подбора товара.
- Ручки, ограничители, наличники, комплекты: отдельные товары в БД, загрузка через hardware API, учёт в цене и в корзине.
- Реверс, зеркало, порог: опции по модели, не отдельные товары; цены из опций модели, в корзине не дублируются отдельными строками.
- Связь листов Excel по «Название модели» явно задана; скрипт проверки и отчёт о недостающих данных (MISSING_DATA_REPORT.md) показывают, где связи нет.

### Слабые места и риски

1. **Несовпадение «Название модели» между листами**  
   Часть моделей из «Цены базовые» не имеет строк в «Цвет», «Опции», «Наценка за кромку», «Стекло_доступность» — для них не будет цветов/фото, опций (реверс/зеркало/порог), кромки, стекла. И наоборот: строки в «Цвет»/«Опции» с другими названиями не привязываются к товарам. **Рекомендация:** унифицировать названия в Excel или ввести слияние по «Код модели Domeo (Web)» в импорте (см. MISSING_DATA_REPORT.md).

2. **Расхождение количества товаров дверей**  
   Ожидается 2323 (разворот по размерам из «Цены базовые»), в БД 1663 — часть комбинаций не создаётся при импорте или отфильтровывается. **Рекомендация:** проверить импорт (условия пропуска строк, парсинг высот/ширин).

3. **Наличники/ручки в БД меньше, чем строк в Excel**  
   Наличники: 17 строк в Excel, 12 в БД; ручки: 126 vs 123. Возможны дубли по имени, неактивные строки или ошибки импорта. **Рекомендация:** сверка по SKU/названию и флагу «Активна».

4. **Завертка (Да/Нет)**  
   Не передаётся в API цены и не хранится в корзине. Если должна влиять на цену или комплектацию — нужен отдельный источник (например, поле в ручке или отдельная опция) и доработка API/корзины.

5. **Цвет в подборе товара**  
   Подбор двери по color должен строго соответствовать значению в БД (Domeo_Цвет или propertyValue). Несоответствие названий цвета между UI и properties_data может дать неверный товар или цену. **Рекомендация:** использовать один и тот же идентификатор/название на фронте и в API (например, color_name из coatings).

6. **Фильтр по наполнению**  
   Работает только если у модели в БД заполнено «Название наполнения» (из листа «Опции»). Для моделей без строк в «Опции» фильтр по наполнению их не покажет. Это согласовано с логикой связей.

### Итог
- Логика калькулятора и путь пользователя согласованы с принятой схемой: опции по модели (реверс, зеркало, порог) не отдельные товары; наличники и ограничители — отдельные товары и строки в корзине; связь данных — по «Название модели» в Excel и по modelKey/style/finish/color/sizes в API.
- Главные риски — полнота и согласованность данных (связи между листами, количество товаров, дубли), а не схема расчёта. Регулярный запуск `verify-excel-db-and-links.ts` и исправление списков из MISSING_DATA_REPORT.md снижают эти риски.

---

## 6. Связанные документы

- **docs/MISSING_DATA_REPORT.md** — недостающие данные и разрывы связей по «Название модели» (генерируется скриптом).
- **docs/CONFIGURATOR_OPTIONS_AND_EXCEL_MAP.md** — список опций на странице и связь с листами Excel.
- **docs/FINAL_FILLED_DATA_MAP.md** — назначение столбцов каждого листа Excel и импорт в БД.
- **docs/CONFIGURATOR_DOORS_LOGIC.md** — технические детали API и хуков (частично устарел после введения doorOptions, kits, limiters, architraves).
