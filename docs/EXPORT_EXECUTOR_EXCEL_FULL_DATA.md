# Экспорт Excel в ЛК исполнителя: заполнение всех колонок без исключения

## Проблема (по скрину)

В экспорте заказа часть колонок остаётся пустой:
- второй столбец **«Цвет»** (дубликат);
- **«Наименование»** (в одной из колонок);
- **«Количество»** (в одной из колонок);
- **«Примечание»**;
- **«Цена»**;
- **«Сумма»**.

При этом первый блок колонок (№, Наименование модели, Ширина, Высота, первый Цвет, опции двери и т.д.) может быть заполнен.

---

## Откуда берётся экспорт в модалке заказа (ЛК исполнителя)

| Действие | API | Генератор Excel |
|----------|-----|------------------|
| Кнопка «Заказ из БД» / «Экспорт заказа у поставщика» в модалке заказа | `POST /api/export/fast` (type: `order`, format: `excel`) | `exportDocumentWithPDF` → `generateExcelOrder` (lib/export/puppeteer-generator.ts) |
| Экспорт по id документа (если есть кнопка «Скачать Excel» по документу) | `GET/POST /api/documents/[id]/export?format=excel` | Тот же `exportDocumentWithPDF` → `generateExcelOrder` для type=order |

Структура листа в текущем коде:
- Строка 10: заголовки = **№**, **Наименование**, **Количество**, **Цена**, **Сумма** (колонки 1–5), затем все поля из `EXCEL_DOOR_FIELDS` (Название модели, Цена опт, Цена РРЦ, Поставщик, Материал/Покрытие, Ширина, Высота, Цвет/Отделка, …).
- Данные по позициям: для каждой строки явно заполняются ячейки 1–5 (№, наименование, кол-во, цена, сумма) и далее колонки из БД/опций.

Если на скрине виден **другой** порядок колонок (сначала «Наименование модели», «Ширина», «Высота», «Количество», «Цвет», много опций, а «Наименование»/«Количество»/«Цена»/«Сумма»/«Примечание» — ближе к концу), то это может быть:
1. Экспорт по **шаблону категории** (другая точка входа, где порядок колонок задаётся `template.exportFields`), или  
2. Старая версия генератора / другой формат.

Ниже — путь решения для **текущего** генератора (puppeteer-generator + export/fast) и общие принципы.

---

## Правильный путь решения

### 1. Один источник правды по данным позиции

Перед генерацией Excel все позиции должны приходить в **нормализованном** виде:

- **Наименование:** либо из `item.name`, либо собирается через `getItemDisplayName(item)` (export-items) по полям модели, покрытия, цвета, размеров, ручки, ограничителя и т.д.
- **Количество:** `item.qty ?? item.quantity ?? 1`.
- **Цена за ед.:** `item.unitPrice ?? item.price ?? 0`.
- **Сумма:** `(qty) * (unitPrice)`.
- **Примечание (если колонка есть):** `item.notes` или сводка из `item.specRows` / опций.

Откуда берутся items при экспорте из модалки исполнителя:

- `currentOrder.invoice?.cart_data` или `currentOrder.cart_data` (OrdersBoard, handleExportSupplierOrder).
- При экспорте по id документа — `document.invoice?.cart_data` или `document.cart_data`, затем маппинг в `itemsForExport` (documents/[id]/export).

Нужно гарантировать, что при любом варианте хранения (строка/объект, items или массив) мы достаём и подставляем в items поля: `name` (или model, finish, color, … для сборки имени), `quantity`/`qty`, `unitPrice`/`price`, и при необходимости `notes`.

### 2. В генераторе Excel — всегда заполнять базовые колонки

В `generateExcelOrder` (и при необходимости в генераторе заказа у поставщика в supplier-orders/[id]/excel):

- Для **каждой** строки товара (включая подстроки по вариантам/подмоделям) явно записывать:
  - колонка 1: № (порядковый номер);
  - колонка 2: **Наименование** = `getDisplayNameForExport(item) || item.name || ''`;
  - колонка 3: **Количество** = `item.qty ?? item.quantity ?? 1`;
  - колонка 4: **Цена** = `item.unitPrice ?? item.price ?? 0`;
  - колонка 5: **Сумма** = количество × цена.
- Использовать те же fallback’и при записи, чтобы даже при «кривых» данных из корзины ячейки не оставались пустыми (например, 0 вместо пустоты для цены/суммы, «—» или пустая строка для имени только если совсем не из чего собрать).

Так мы устраняем пустые «Наименование», «Количество», «Цена», «Сумма» в текущей структуре листа.

### 3. Колонка «Примечание»

Если в целевом шаблоне/формате есть колонка «Примечание»:

- Добавить её в список заголовков (например, после «Сумма» или в конце строки).
- Заполнять из `item.notes` или из сформированного текста (например, из `item.specRows` или перечисления опций). Если данных нет — оставлять пустую строку.

Если текущий лист строится без «Примечание», но по ТЗ она нужна — добавить один столбец и заполнять его так же централизованно.

### 4. Два столбца «Цвет»

Если в шаблоне два столбца «Цвет»:

- Либо оба заполнять одним и тем же значением (из `item.color` или из свойств товара БД «Цвет/Отделка»).
- Либо второй столбец — из другого источника (например, «Цвет кромки»); тогда нужно явно завести для него поле и маппинг в генераторе.

В текущем `EXCEL_DOOR_FIELDS` есть один «Цвет/Отделка». Если в файле пользователя второй «Цвет» — это дубликат для удобства печати/учёта, достаточно продублировать значение во вторую колонку при записи строки.

### 5. Экспорт по шаблону категории (если используется)

Если где-то в ЛК исполнителя или в модалке заказа вызывается экспорт, который строит лист по **шаблону** (например, `template.exportFields` из категории дверей):

- Нужно найти этот код (например, в api/documents/generate, api/supplier-orders, или отдельный endpoint по шаблону).
- Для каждого поля шаблона определить источник данных: корзина (item.name, item.qty, item.unitPrice, item.total, item.notes) или свойства товара из БД.
- Явно заполнять **все** колонки, соответствующие «Наименование», «Количество», «Цена», «Сумма», «Примечание», «Цвет» (и второй «Цвет», если есть), а не только часть полей из БД.

Тогда в экспорте по шаблону тоже не останется пустых колонок.

### 6. Проверка данных при открытии модалки

Уже сделано (см. EXCEL_EXPORT_EXECUTOR_VERIFICATION.md): при открытии модалки заказа вызывается `loadFullOrder()` и подставляется `invoice.cart_data`. Для экспорта используется тот же источник. Стоит убедиться, что при сохранении счёта/заказа в `cart_data` всегда попадают поля: `name` (или model, finish, color, width, height, … для дверей), `quantity`/`qty`, `unitPrice`/`price`, и по возможности `notes`. Тогда и отображение в модалке, и экспорт будут с полными данными.

---

## Итог: что сделать по шагам

1. **В коде генератора Excel (generateExcelOrder и при необходимости supplier-orders excel):**  
   Для каждой строки товара всегда записывать в ячейки 1–5 значения с fallback’ами: №, наименование (getDisplayNameForExport(item) || item.name || ''), количество, цена, сумма. Не полагаться на то, что «уже где-то записали» — явно выставить все пять для каждой строки.

2. **При сборке items для экспорта (OrdersBoard, documents/[id]/export):**  
   Сохранять и передавать в API все доступные поля: name, model, finish, color, width, height, qty, quantity, unitPrice, price, notes, breakdown, model_name, matchingVariants и т.д., чтобы нормализация и getItemDisplayName могли собрать полное наименование и цены.

3. **Колонка «Примечание»:**  
   Если она есть в целевом формате — добавить в заголовки и заполнять из item.notes или аналога.

4. **Второй «Цвет»:**  
   Если в шаблоне две колонки «Цвет» — заполнять обе (например, одной и той же величиной из item.color / «Цвет/Отделка»).

5. **Если пустые колонки остаются:**  
   Зафиксировать, из какой именно кнопки/страницы идёт экспорт (URL, тип документа), и проверить, не используется ли отдельный путь с шаблоном. При необходимости добавить маппинг недостающих колонок в этом пути.

После этого экспорт в модальном окне заказа в ЛК исполнителя будет заполнять все данные без исключения в рамках выбранной структуры листа.
